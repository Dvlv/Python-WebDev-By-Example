<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Dvlv" />
  <meta name="description" content="A hands-on introduction to web development in python" />
  <title>title</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">truetrue</h1>
<p class="author">Dvlv</p>
</header>
<h1 id="chapter-0">Chapter 0</h1>
<h2 id="introduction">Introduction</h2>
<p>Welcome to this e-book teaching how to create web applications using primarily Flask, Peewee, and Pytest.</p>
<p>Throughout this book we will be setting up a digital shop site which will have a distinct public front-end and a gated back-end. Your shop will have a persistent database, a comprehensive suite of automated tests, and the ability to process data separately from the main web server.</p>
<p>Each chapter will introduce the relevant library in a hands-on approach, rather than dumping a heap of documentation upon the reader. If you’re someone who would prefer to broaden your knowledge of a library before getting stuck-in with it, I have included appendices at the end which go over the syntax of each library in greater detail. As I am not the author of any of these libraries, there’s always a chance that the information becomes outdated, so pay attention to the version numbers at the top of each appendix.</p>
<h3 id="coverage-and-assumptions">Coverage and Assumptions</h3>
<p>We will be covering python and the titular libraries specifically. The front-end of the site will be written using normal Javascript and Flask’s Jinja template - no fancy frameworks or webpack here.</p>
<p>As I use Linux on my computers, the commands will be written assuming a unix-like operating system with a <code>bash</code> shell. If you are on Windows, I would recommend using the Windows Subsystem for Linux (WSL) to follow along. Setting this up is outside the scope of this book, so search online for something like “WSL Install Windows 10” to get started. Familiarity with using a terminal is required, as we will need to run various elements of the web server via the command line.</p>
<p>I will also not be teaching the Python language itself - you will need to be familiar with the language to follow along properly. For the best experience, a reader should have a grasp of functions, classes, and importing modules. Decorators are also used a lot in Flask, so a brief understanding of those is also recommended.</p>
<p>With that out of the way, let’s begin with some basics.</p>
<h2 id="installing-pyenv-and-poetry">Installing Pyenv and Poetry</h2>
<p>While there are many ways to install Python itself, and manage its dependencies, we will be using a tool called <code>pyenv</code> to install a specific version of the Python language, and a tool called <code>poetry</code> (along with in-built virtualenvs) to install dependencies.</p>
<p>If you already know what you are doing, already have a python installation, or you prefer to use other tools to manage installations, feel free to skip the rest of this section.</p>
<p>For this book, we will be using Python 3.10.</p>
<h3 id="installing-python-via-pyenv">Installing Python via Pyenv</h3>
<p>The <code>pyenv</code> tool is available over on Github, and comes with a very easy install script.</p>
<blockquote>
<p>Please note, I am not the author of this tool, and so have no control over the contents nor the hosting. This means the links below may disappear at some point.</p>
</blockquote>
<p>Before installation, follow the instructions for getting the necessary dependencies for your operating system from this URL:</p>
<blockquote>
<p>https://github.com/pyenv/pyenv/wiki#suggested-build-environment</p>
</blockquote>
<p>Once you have the dependencies taken care of, installing pyenv is as simple as cloning the repo and running a script.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/pyenv/pyenv-installer</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> pyenv-installer</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">bin/pyenv-installer</span></span></code></pre></div>
<p>The installer will use <code>git</code> to grab the necessary repos for you, and set up a <code>.pyenv</code> folder in your home directory to contain both pyenv itself and any installed python versions.</p>
<p>With <code>pyenv</code> taken care of, it’s time to install python 3.10:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">.pyenv/bin/pyenv</span> install 3.10.1</span></code></pre></div>
<p>This command will take some time to run. If you missed any of the pre-requisite dependencies you may see some errors here. Refer back to the wiki to sort those out.</p>
<p>Once your install is successful, we’re done with pyenv!</p>
<h3 id="installing-dependencies-with-poetry">Installing dependencies with poetry</h3>
<p>Now that we have the correct version of Python installed, it’s time to grab the titular libraries. We will be using a tool called <code>poetry</code> to achieve this, which is easily installed using Python’s built-in <code>pip</code> module.</p>
<h4 id="setting-up-a-project-directory">Setting up a project directory</h4>
<p>We’ll need to make a folder to store our project. This can be anywhere on your system, and can be moved at any time, so there’s no need to worry too much.</p>
<p>When you’ve chosen where to store your project, create a new directory called <code>flask-peewee-pytest</code> and <code>cd</code> into it.</p>
<h4 id="creating-a-virtualenv">Creating a Virtualenv</h4>
<p>The first step is to create a virtual environment using the pyenv-provided version of Python.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.pyenv/versions/3.10.1/bin/python3</span> <span class="at">-m</span> venv env</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> env/bin/activate</span></code></pre></div>
<p>Now that we have the virtual environment, we can install <code>poetry</code> into it.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">--upgrade</span> pip</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install poetry</span></code></pre></div>
<p>Before we can begin installing with poetry, we need a <code>pyproject.toml</code> file. Don’t worry if you don’t know what this is, because <code>poetry</code> can generate one for us!</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> init</span></code></pre></div>
<p>Simply follow the prompts, choosing <code>n</code> to skip setting dependencies interactively - we will do this via the command line shortly.</p>
<p>Once this command finishes you will have a nice new <code>pyproject.toml</code> file.</p>
<h4 id="installing-dependencies">Installing dependencies</h4>
<p>To add dependencies via poetry, simply use <code>poetry add</code>. To specify development-only dependencies, it’s <code>poetry add --dev</code>.</p>
<p>Let’s install the titular dependencies to our virtual environment. Since our unit tests will not be running in production, we add <code>pytest</code> as a development dependency:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> add flask peewee</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> add <span class="at">--dev</span> pytest</span></code></pre></div>
<p>That’s it, we’ve now got our three main dependencies installed, and are ready to begin writing our web-app. Get your editor / IDE of choice ready for the next chapter!</p>
<h1 id="chapter-1">Chapter 1</h1>
<h2 id="flask-beginnings">Flask Beginnings</h2>
<p>With our development environment taken care of, let’s dive right in to Flask. In this chapter we’ll go over the basics of getting a Flask server up-and-running, then look into how to structure the web side of our project in a maintainable way.</p>
<h3 id="hello-flask">Hello Flask</h3>
<p>In keeping with programming tradition, let’s start with a “Hello Flask” implementation.</p>
<p>In your project folder, create a file called <code>web_server.py</code> and add the following:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>app.secret_key <span class="op">=</span> <span class="st">&quot;very secret&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_flask():</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;Hello, Flask!&quot;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    app.run(debug<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>Save this file and run the webserver with <code>python3 web_server.py</code>. You should see a message telling you that the server is available on <code>http://127.0.0.1:5000/</code>. Visit this URL in a browser and you’ll be presented with “Hello, Flask!”.</p>
<blockquote>
<p>Note: Mac users may find that port 5000 is already in use. To get around this, add the <code>port=8080</code> argument to your <code>app.run</code> call, and visit <code>http://localhost:8080/</code>.</p>
</blockquote>
<p>Not too much code went into making that, so let’s go over it.</p>
<p>First we import <code>Flask</code> itself, and create an instance named “app”. Passing the <code>__name__</code> argument is convention.</p>
<p>Once we have our Flask instance, we need to set a secret key. This is used to encrypt session data, and so in a production environment should be a lot more secure than this simple string. We will come back to this later.</p>
<p>With our sessions secure, we now need to add some routes to our server. This is achieved by decorating a function with the <code>route</code> decorator, passing the URL as the argument, so “/” in this case. Inside this function we must return something which can be recognised by Flask as an HTTP response (typically a string, a dictionary, or a rendered template, which we will see shortly).</p>
<p>That’s it, we now have a server with a URL set up. The <code>if __name__ == "__main__"</code> block allows us to run this file as a script to launch the server, while also allowing other files to import from it without also causing the server to run. We use the <code>run</code> function to start our server, and pass <code>debug=True</code> to enable the debugging interface.</p>
<p>To have a look at the debugging screen, add the line <code>1 / 0</code> above the <code>return</code> statement in your <code>hello_flask</code> method, then reload the page. You should see a <code>ZeroDivisionError</code> screen with a nice stack trace showing the problematic line.</p>
<h3 id="rendering-html">Rendering HTML</h3>
<p>We know how to return plain text, but <em>real</em> websites use HTML, so how do we do that? Flask comes with a popular templating library called <code>Jinja</code> supported by default, as well as a helper function to both compile the template contents and return it as an HTTP response. Let’s turn our homepage into something a bit more realistic.</p>
<p>Create a <code>templates</code> folder in the root of your project, and then create an <code>index.html</code> file inside.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Welcome to my shop!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;table&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;tr&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>Toothpaste<span class="kw">&lt;/td&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>£2<span class="kw">&lt;/td&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;tr&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>Toothbrush<span class="kw">&lt;/td&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>£1.50<span class="kw">&lt;/td&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;tr&gt;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>Floss<span class="kw">&lt;/td&gt;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>£0.99<span class="kw">&lt;/td&gt;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/table&gt;</span></span></code></pre></div>
<p>(Note that this is not “fully-formed” HTML, but a browser should render it anyway. We will deal with this later).</p>
<p>Template created! Now we need to render it. Hop back over to your <code>web_server.py</code> file and edit your <code>hello_flask</code> function as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index():</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;index.html&quot;</span>)</span></code></pre></div>
<p>We’ll start by renaming the function to <code>index</code>, as it better describes the page we’ll be rendering.</p>
<p><code>render_template</code> is a helper function in Flask which will perform Jinja rendering and return your HTML as an HTTP response. We will need to import this though, so go up to the top of your file and import the library from flask</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>form flask <span class="im">import</span> Flask, render_template</span></code></pre></div>
<p>Run your web server once more and reload the index page. You should see a beautiful table of prices.</p>
<p>Obviously it would be rather daft to have to edit HTML directly when your shop’s stock changes - this information should be stored in a database and pulled out on the server side. We’ll get to the database itself next chapter, but for now we can pretend, and learn about Jinja rendering along the way.</p>
<h4 id="using-variables-in-jinja">Using variables in Jinja</h4>
<p>In your <code>web_server.py</code> file, change the <code>index</code> function and add a dictionary of products to prices like so:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hello_flask():</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    products <span class="op">=</span> {<span class="st">&quot;toothpaste&quot;</span>: <span class="fl">2.00</span>, <span class="st">&quot;toothbrush&quot;</span>: <span class="fl">1.50</span>, <span class="st">&quot;floss&quot;</span>: <span class="fl">0.99</span>}</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;index.html&quot;</span>, products<span class="op">=</span>products)</span></code></pre></div>
<p>When using <code>render_template</code>, any arguments passed after the filename of the HTML file will be passed to the template to be used by Jinja. This is known as the “template context”.</p>
<p>Change the content of your <code>templates/index.html</code> file to the following:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Welcome to my shop!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;table&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    {% for product_name, price in products.items() %}</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;tr&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>{{product_name}}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>{{ &quot;£%.2f&quot;|format(price) }}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    {% endfor %}</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/table&gt;</span></span></code></pre></div>
<p>To use our variables in Jinja, we need to utilise two different sets of special syntax: the double-brace <code>{{</code> <code>}}</code> and the percent-brace <code>{%</code> <code>%}</code>. Percent-brace tags are used to insert logic, such as <code>for</code> loops and <code>if</code> statements. The double-brace is used to insert python variables as text inside the template.</p>
<p>In the above example, we use the percent-brace syntax to initiate a <code>for</code> loop, iterating over our <code>products</code> variable and unpacking the keys and values into two python variables - <code>product_name</code> and <code>price</code>. We then place the product names as text into our HTML by using the double-brace syntax. We do the same for the price, but use a pipe into a format string to get the correct currency display.</p>
<p>The pipe character is Jinja’s own syntax (rather than python’s) which passes the variable into a function exposed by Jinja to the templates. You can think of these as reversing the order of a normal function from <code>my_func(variable)</code> to <code>variable|my_func</code>.</p>
<p>We now have a single page listing all of our products, so let’s add individual pages for each one. Again, it’s not manageable to create a specific route for each product, so we’ll need to make use of the database’s information in Flask.</p>
<h3 id="using-variables-in-flask-routes">Using variables in Flask routes</h3>
<p>Underneath your <code>index</code> function, add the following:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&quot;/&lt;string:product_name&gt;&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_product(product_name):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    products <span class="op">=</span> {<span class="st">&quot;toothpaste&quot;</span>: <span class="fl">2.00</span>, <span class="st">&quot;toothbrush&quot;</span>: <span class="fl">1.50</span>, <span class="st">&quot;floss&quot;</span>: <span class="fl">0.99</span>}</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> product_name <span class="kw">in</span> products:</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> products[product_name]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        abort(<span class="dv">404</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;products/view_product.html&quot;</span>, price<span class="op">=</span>price, product_name<span class="op">=</span>product_name</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p>We now have a route which can take a variable from the URL, as you can see from the <code>route</code> decorator. This <code>product_name</code> variable is then passed into our <code>view_product</code> function automatically. We have annotated this variable as a <code>string</code>, so that we can guarantee the type of the python variable passed.</p>
<p>The rest of this function searches our <code>products</code> dictionary for the provided string, and if found sets the value of <code>price</code>. If the product is not in the dictionary, we use a flask helper to return an HTTP 404 response.</p>
<p>Adjust your import statement at the top of the file to include this function:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask, render_template, abort</span></code></pre></div>
<p>To make our server run we’ll need to make that new template. Go ahead and create a folder inside your <code>templates</code> folder called <code>products</code>, then create an HTML file inside called <code>view_product.html</code> containing the following:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Welcome to my shop<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2&gt;</span>{{product_name}}<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>This product costs £{{&quot;%.2f&quot;|format(price)}}<span class="kw">&lt;/p&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>Out of Stock<span class="kw">&lt;/p&gt;</span></span></code></pre></div>
<p>After you save this file, your server should be able to run again, so start it up with <code>python3 web_server.py</code> and head on over to <code>localhost:5000</code>. You should see your index page.</p>
<p>Add the name of a product to the end of your URL, for example <code>/toothpaste</code>, and you should see your new template render. You can also try using a product which doesn’t exist, such as <code>/water</code>, to see the 404 error page.</p>
<p>Now we have two templates which both share the same header at the top of the page. It would be a hassle to keep copy-pasting that into each new file, and we haven’t got the proper HTML declarations in our templates either. We’ll sort that out now by looking at template inheritance.</p>
<h3 id="template-inheritance">Template Inheritance</h3>
<p>Jinja allows templates to inherit from others using two main tags:</p>
<ul>
<li><code>{% extends %}</code></li>
<li><code>{% block %}</code></li>
</ul>
<p>Let’s see these in action by creating a base template. Add a file called <code>base.html</code> in your <code>templates</code> folder:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;head&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;title&gt;</span>My Shop<span class="kw">&lt;/title&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/head&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;body&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;h1&gt;</span>Welcome to my shop!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;hr&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        {% block content %}</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        {% endblock %}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/body&gt;</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span> </span></code></pre></div>
<p>We use a <code>block</code> tag to assign a name and location to a piece of inheritable content. Since we have created a <code>block</code> named <code>content</code> inside our <code>body</code> tags, any template inheriting our base can include a <code>{% block content %}</code> tag to insert its contents into the page <code>body</code>.</p>
<p>Let’s alter our <code>index.html</code> and <code>view_product.html</code> templates to inherit from the base.</p>
<p><code>index.html</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>{% extends &quot;base.html&quot; %}</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>{% block content %}</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;table&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    {% for product_name, price in products.items() %}</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;tr&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;/{{product_name}}&quot;</span><span class="kw">&gt;</span>{{product_name}}<span class="kw">&lt;/a&gt;&lt;/td&gt;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>{{ &quot;£%.2f&quot;|format(price) }}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    {% endfor %}</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/table&gt;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>{% endblock %}</span></code></pre></div>
<hr />
<p><code>view_product.html</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>{% extends &quot;base.html&quot; %}</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>{% block content %}</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2&gt;</span>{{product_name}}<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>This product costs £{{&quot;%.2f&quot;|format(price)}}<span class="kw">&lt;/p&gt;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>Out of Stock<span class="kw">&lt;/p&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>{% endblock %}</span></code></pre></div>
<p>Save and re-run your webserver and visit both the homepage and a product page (you may notice we added <code>a</code> tags so that you can visit a product page by clicking on the product’s name). They should both look just like before, but now have fully-formed HTML and are sharing the heading. Use the “Inspect Element” or “View Source” capabilities of your web browser to have a look at the generated HTML and see this for yourself.</p>
<p>The <code>extends</code> tag takes the name of the base template in quotes, then exposes all blocks defined in that template to the current file (although you do not need to add content to <em>all</em> blocks defined in the base). The content which is wrapped in <code>{% block content %}</code> in our child templates is then inserted into the base template where its own <code>{% block content%}</code> tags lie.</p>
<p>This covers the basics of flask. We now have a working web server, which we can add routes to using the <code>@app.route</code> decorator. We know how to pass variables to these routes using <code>/&lt;string:variable&gt;</code>, and how to get python variables into Jinja templates.</p>
<p>To continue with our website, we will now look at replacing those hard-coded <code>products</code> dictionaries with data from an actual database, as we dive into the <code>Peewee</code> libarary.</p>
<h1 id="chapter-2">Chapter 2</h1>
<h2 id="using-peewee-with-a-database">Using Peewee with a Database</h2>
<p>Peewee is a library often referred to as an Object Relational Mapper (ORM). It abstracts connections to a database into regular Python objects to make querying integrate seamlessly with the rest of your backend logic.</p>
<p>If you’d like a detailed look into Peewee <em>before</em> diving in, check out <a href="#appendix-1---peewee">Appendix 1</a>.</p>
<h3 id="making-a-database">Making a database</h3>
<p>We’re going to be using SQLite in this book, because it doesn’t require any installation or set-up. As Peewee is an abstraction layer, code from this book should work fine with a more dedicated solution, such as MySQL or Postgres.</p>
<p>Let’s begin by creating a folder in the root directory called <code>models</code>, and inside add two files - <code>__init__.py</code> and <code>product.py</code>.</p>
<p><code>__init__.py</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peewee <span class="im">import</span> Model</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playhouse.sqlite_ext <span class="im">import</span> SqliteExtDatabase</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BaseModel(Model):</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Meta:</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        database <span class="op">=</span> SqliteExtDatabase(<span class="st">&quot;database.db&quot;</span>)</span></code></pre></div>
<hr />
<p><code>product.py</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models <span class="im">import</span> BaseModel</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playhouse.sqlite_ext <span class="im">import</span> <span class="op">*</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Product(BaseModel):</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> AutoField()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> TextField()</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> TextField()</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Meta:</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        table_name <span class="op">=</span> <span class="st">&quot;product&quot;</span></span></code></pre></div>
<p>In our init file we import Peewee’s own <code>Model</code> class and its class for connecting to a Sqlite database. Using these we can define a <code>BaseModel</code> class which will act as a child class for each of our models. Inside this class, we include another named <code>Meta</code> which is used by Peewee to point the models to their database. As we are using Sqlite for this book, we can simply point this to a file named <code>database.db</code>.</p>
<p>Our <code>Product</code> model imports our new <code>BaseModel</code> class and inherits from it. The column datatypes from Peewee’s Sqlite extension are also brought in.</p>
<p>Models are linked to their database columns by providing class attribues which are instances of Peewee’s column types. Here we have an <code>AutoField</code> - used to denote a primary key in other database engines such as Postgres or MySQL - and two <code>TextField</code>s to store each product’s name and price.</p>
<p>Another <code>Meta</code> subclass is used on our <code>Product</code> model to indicate its table name in the Sqlite database.</p>
<p>Speaking of which, let’s get this prepared now.</p>
<h4 id="database-migrations">Database Migrations</h4>
<p>Create a new folder in the root of your project called <code>migrations</code>. Create a file in here called <code>V1__create_product_table.sql</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> product (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span> autoincrement, name text, price text);</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> product <span class="kw">values</span> (<span class="dv">1</span>, <span class="ot">&quot;Toothpaste&quot;</span>, <span class="ot">&quot;2.0&quot;</span>), (<span class="dv">2</span>, <span class="ot">&quot;Toothbrush&quot;</span>, <span class="ot">&quot;1.50&quot;</span>), (<span class="dv">3</span>, <span class="ot">&quot;Floss&quot;</span>, <span class="ot">&quot;0.99&quot;</span>);</span></code></pre></div>
<p>Great, now we have our first database migration! You may be wondering about that file name, so I shall explain. This naming schema is used by a product named FlywayDB, an open source generic database migration tool. By naming our migrations as such, we have the option to use this tool to handle our database if we want. Since Flyway uses plain SQL files to handle its migrations, it is possible to run our migrations manually if you would prefer not to set this tool up.</p>
<h5 id="setting-up-flyway">Setting up Flyway</h5>
<p>Search the web for FlywayDB’s download page and grab the relevant version for your operating system. Make sure to extract the folder inside your project’s root directory. Rename the extracted folder, which should be <code>flyway-x.y.z</code> to just <code>flyway</code> for simplicity.</p>
<p>Inside the <code>flyway</code> folder you should have another named <code>conf</code>, containing a file <code>flyway.conf</code>. Open up this file and remove the default contents, then enter the following:</p>
<pre><code>flyway.url=jdbc:sqlite:database.db
flyway.user=
flyway.password=
flyway.locations=migrations</code></pre>
<p>Just one more thing before we can start using <code>flyway</code> - the first migration it finds is expected to be the “baseline” of the table, which means its initial state before any flyway migrations. If we run flyway now, it will assume this is V1 and not create our table, so we need to create an empry file inside the <code>migrations</code> folder called <code>V0__baseline.sql</code>.</p>
<p>We are now ready! Make sure you are in the project root and run the following command:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">flyway/flyway</span> migrate</span></code></pre></div>
<p>If successful, you should see some confirmation output like the following:</p>
<pre><code>Flyway is up to date
Flyway Community Edition 8.5.2 by Redgate
See what&#39;s new here: https://flywaydb.org/documentation/learnmore/releaseNotes#8.5.2

Database: jdbc:sqlite:database.db (SQLite 3.34)
Successfully validated 2 migrations (execution time 00:00.006s)
Creating Schema History table &quot;main&quot;.&quot;flyway_schema_history&quot; ...
Current version of schema &quot;main&quot;: &lt;&lt; Empty Schema &gt;&gt;
Migrating schema &quot;main&quot; to version &quot;0 - baseline&quot;
Migrating schema &quot;main&quot; to version &quot;1 - create tables&quot;
Successfully applied 2 migrations to schema &quot;main&quot;, now at version v1 (execution time 00:00.014s)</code></pre>
<p>Congratulations, you now have a database!</p>
<h5 id="skipping-flyway-and-running-migrations-manually">Skipping Flyway and Running Migrations Manually</h5>
<p>If you’d prefer to skip setting up Flyway, you can run the sqlite migrations from the command line directly.</p>
<p>First execute the <code>sqlite3 database.db</code> command to drop into a sqlite shell for your database. Then run each file like so:</p>
<pre class="sqlite"><code>.read migrations/Vx__name_of_file.sql</code></pre>
<p>If you receive an error about the <code>sqlite3</code> command not being found, you may need to install it on your computer first.</p>
<h3 id="using-our-database">Using our Database</h3>
<p>Now that our database exists, and has contents, we can begin using our Peewee models in our Flask endpoints.</p>
<p>Open up <code>web_server.py</code> and change your two routes to the following:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index():</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    products <span class="op">=</span> Product.select()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;index.html&quot;</span>, products<span class="op">=</span>products)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">&quot;/&lt;string:product_name&gt;&quot;</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_product(product_name):</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    product <span class="op">=</span> Product.get_or_none(Product.name <span class="op">==</span> product_name)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> product:</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> abort(<span class="dv">404</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;products/view_product.html&quot;</span>, price<span class="op">=</span>product.price, product_name<span class="op">=</span>product_name</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p>We’ll also need to import our <code>Product</code> model at the top:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.product <span class="im">import</span> Product</span></code></pre></div>
<p>If you are familiar with SQL syntax, Peewee’s methods should feel familiar. We use <code>Product.select()</code> to grab all product records from our database - the equivalent of <code>SELECT * FROM product</code>. This returns an <code>iterable</code> of objects representing our database rows, with each class attribute we defined in <code>models/product.py</code> containing the data from our row.</p>
<p>In our <code>view_product</code> endpoint we need to fetch a specific row, so we use Peewee’s <code>get_or_none</code> function. This function needs to be supplied with any conditions on which to select the correct product. Since we have the product’s name as our <code>product_name</code> variable, we pass this as a condition to Peewee with <code>Product.name == product_name</code>. This tells Peewee’s query to find a row with a <code>name</code> record matching what’s in our <code>product_name</code> variable. This is the equivalent of <code>SELECT * from product WHERE name = product_name</code> (and “product_name” is actually the contents of the variable).</p>
<p>Since the <code>get_or_none</code> method returns <code>None</code> if no matching record is found, we can use this to return our <code>abort(404)</code> if a non-existing product name is passed.</p>
<p>The arguments to <code>render_template</code> update to pass the <code>product</code> variable’s <code>price</code> attribute to the <code>price</code> context.</p>
<p>Our templates won’t quite render yet, since they are expecting <code>dict</code>s for the product information. Let’s start with <code>index.html</code>, change the contents of your <code>table</code> to the following:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;table&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    {% for product in products %}</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;tr&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;/{{product.name}}&quot;</span><span class="kw">&gt;</span>{{product.name}}<span class="kw">&lt;/a&gt;&lt;/td&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;td&gt;</span>{{ &quot;£%.2f&quot;|format(product.price|float) }}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    {% endfor %}</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/table&gt;</span></span></code></pre></div>
<p>We are now iterating over python objects representing our database rows, rather than <code>dict</code>s, so we no longer need <code>.items()</code>, and can use the dot syntax to access attributes.</p>
<p>Since <code>price</code> is a String in our database, it must be passed to the <code>float</code> filter before it can be formatted via the <code>format</code> filter.</p>
<p>And now in <code>view_product.html</code>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2&gt;</span>{{product_name}}<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>This product costs £{{&quot;%.2f&quot;|format(price|float)}}<span class="kw">&lt;/p&gt;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>Out of Stock<span class="kw">&lt;/p&gt;</span></span></code></pre></div>
<p>Just the <code>price</code> to be converted to a <code>float</code> once again in this file.</p>
<p>With all of those changes in place, you can now run your webserver with <code>python3 web_server.py</code> and visit your shop once again. It should work exactly as before.</p>
<p>That’s all it takes to get a database into our site! Before we start adding functionality, we should first go over way to ensure our site will always work as intended. This leads us nicely to our last titular module - Pytest.</p>
<h1 id="chapter-3">Chapter 3</h1>
<h2 id="testing-with-pytest">Testing with Pytest</h2>
<p>Automated tests allow us to ensure that our site’s expected functionality will stay the same as we continue adding features. This prevents us from having to manually use each aspect of our site every time we make changes.</p>
<p>If you’d like a detailed look into Pytest before diving in, check out <a href="#appendix-2---pytest">Appendix 2</a>.</p>
<p>To get started with Pytest, create a folder in the root directory of your project named <code>tests</code> and inside create a file named <code>helpers.py</code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.product <span class="im">import</span> Product</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>__all__ <span class="op">=</span> [<span class="st">&quot;create_test_product&quot;</span>]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_test_product(name: <span class="bu">str</span>, price: <span class="bu">str</span>):</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> Product()</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    p.name <span class="op">=</span> name</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    p.price <span class="op">=</span> price</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    p.save()</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> p</span></code></pre></div>
<p>All helper functions for our tests will be stored in this file. This avoids having to either re-define them in multiple tests, or elongate each test function by creating models manually.</p>
<p>We start off with just one function - <code>create_test_product</code> - which will create a record in our Product database table with the supplied name and price. Creating a record in Peewee can be done by creating an instance of a model class. You can then assign values to each of the defined class attributes representing the data to be stored for each column. Once the necessary fields are populated, the <code>save</code> method will write this new row to the database.</p>
<p>We also define an <code>__all__</code> variable, which is a special python variable to allow a cleaner use of <code>import *</code> statements. When a file uses <code>from tests.helpers import *</code> it will normally import all definitions contained in that file. This means it would import the <code>Product</code> class in this file’s current state. However, when we define <code>__all__</code> only the definitions inside this list will be imported. This means, in the file’s current state, any test using <code>from tests.helpers import *</code> will <em>only</em> be importing our <code>create_test_product</code> function, and <em>not</em> the <code>Product</code> class.</p>
<p>With this database helper function in place, we now need the ability to switch our Flask server into test mode. Create another file in the <code>tests</code> folder, this time named <code>__init__.py</code>:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web_server <span class="im">import</span> app</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>app.config.update(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;TESTING&quot;</span>: <span class="va">True</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>testing_app <span class="op">=</span> app.test_client()</span></code></pre></div>
<p>This file will create a new variable called <code>testing_app</code> which is just our Flask server in testing mode. We can now use methods such as <code>get</code> and <code>post</code> to issue requests to our server inside tests.</p>
<p>Let’s now create our first test. We will load up the index page of the site and check each product is displayed.</p>
<p>Create a file named <code>test_products.py</code> in your <code>tests</code> folder:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tests <span class="im">import</span> testing_app</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tests.helpers <span class="im">import</span> <span class="op">*</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_index_displays_product_names():</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.00&quot;</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    create_test_product(<span class="st">&quot;Toothpaste&quot;</span>, <span class="st">&quot;1.00&quot;</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.status_code <span class="op">==</span> <span class="dv">200</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    res_data <span class="op">=</span> res.get_data().decode(<span class="st">&quot;utf-8&quot;</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">&quot;Toothbrush&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">&quot;Toothpaste&quot;</span> <span class="kw">in</span> res_data</span></code></pre></div>
<p>We grab our <code>testing_app</code> server and use a star-import to pull in our <code>create_test_product</code> helper.</p>
<p>The <code>test_index_displays_product_names</code> function begins by creating two products in our database, then uses <code>testing_app</code> to issue a request to the index page of our site. We then use an <code>assert</code> statement to ensure that the HTTP status code of the response was 200 Successful.</p>
<p>Once we know the request was successful, we then get the HTML returned by the endpoint using <code>res.get_data()</code> and decode it into a UTF-8 string. We can then test that this string contains the names of our two test products.</p>
<p>We are now ready to run this test - but wait! Our database models are still pointing to our main database, which could be our production database. Obviously we need an ephemeral copy which can be populated and checked-against for each test, and then cleared away ready for the next. This both prevents data from ending up in our real database, and allows unit tests to run without needing to keep track of which previous tests may have added or removed records.</p>
<p>There are multiple ways to solve this problem, but the way I find easiest is to use a decorator above each test which passes in only the tables required for this particular test to run.</p>
<p>Head back to <code>tests/helpers.py</code> and add in the following:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> wraps</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playhouse.sqlite_ext <span class="im">import</span> SqliteExtDatabase</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>__all__ <span class="op">=</span> [<span class="st">&quot;create_test_product&quot;</span>, <span class="st">&quot;with_test_db&quot;</span>]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> with_test_db(dbs: <span class="bu">tuple</span>):</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> decorator(func):</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">@wraps</span>(func)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> test_db_closure(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>            test_db <span class="op">=</span> SqliteExtDatabase(<span class="st">&quot;:memory:&quot;</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> test_db.bind_ctx(dbs):</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>                test_db.create_tables(dbs)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>                    func(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">finally</span>:</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>                    test_db.drop_tables(dbs)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>                    test_db.close()</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> test_db_closure</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decorator</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p>This function takes a <code>tuple</code> of Peewee models, creates a new, in-memory Sqlite database and binds it to the provided models. It then runs the decorated function, drops all tables in the database, and closes the connection.</p>
<p>Head back to <code>test_products.py</code> and wrap our test with the new decorator:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.product <span class="im">import</span> Product</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_index_displays_product_names():</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    ...</span></code></pre></div>
<p>Note the trailing comma inside our tuple. Without this, python will interpret our <code>Product</code> model as a single independent argument, rather than as part of a one-item tuple.</p>
<p><em>Now</em> we are finally ready to run our test. Open up a command line at the root of your project and run the <code>pytest</code> command. Hopefully you should see a success message saying <code>1 passed</code> in green.</p>
<p>If you see an error about packages not being found, you may need to adjust the <code>PYTHONPATH</code> environment variable. In Linux or MacOS running bash or zsh, this should be done like so:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PYTHONPATH</span><span class="op">=</span>.</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pytest</span></span></code></pre></div>
<p>Congratulations, you have now written your first test for this project! Let’s not get ahead of ourselves though, there’s still another page to test. Let’s add more tests to <code>test_products</code>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_view_product_shows_product_name_and_price():</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.00&quot;</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="st">&quot;/Toothbrush&quot;</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.status_code <span class="op">==</span> <span class="dv">200</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    res_data <span class="op">=</span> res.get_data().decode(<span class="st">&quot;utf-8&quot;</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">&quot;Toothbrush&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="st">&quot;£2.00&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_view_product_shows_404_if_not_found():</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.00&quot;</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="st">&quot;/Bananas&quot;</span>)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.status_code <span class="op">==</span> <span class="dv">404</span></span></code></pre></div>
<p>These new tests will both load the <code>view_product</code> route. The first will load a valid product and check the name and price are displayed on the page. The second loads a non-existent product and asserts that the HTTP response is a 404.</p>
<p>Head back to your command line and run your tests again with <code>pytest</code>. You should now see <code>3 passed</code> in green.</p>
<p>Great, now we can assure that our site’s basic functionality is in place just by running the <code>pytest</code> command at any time. Let’s now progress the abilities of our site by adding a separate section for admininstrators, where they can enter details of new products without writing SQL migrations.</p>
<h1 id="chapter-4">Chapter 4</h1>
<h2 id="adding-admin-controls">Adding Admin Controls</h2>
<p>Database migrations are typically used to control the structure of your database tables, rather than their content. Our initial migration added three products only to get us back to the same point we were at before, when our data was in dictionaries. If we want to continue adding products, we should build some way to do it within the application itself.</p>
<p>In order to achieve this, we will now create a separate section of our shop which will serve as an admin panel. We will gate this section behind a login system, as here users will be able to add / remove products from our shop, and change their prices.</p>
<p>We will start by creating two new pages on our site - <code>/admin</code> for the admin section, and <code>/admin/login</code> for an admin user to log in.</p>
<p>Following the current conventions of our code, you may think that these routes would go in the <code>web_server.py</code> file, since that’s where our other pages are held. However, as our application grows, this file will become much too big. As well as this, our admin URLs will always want to begin with <code>/admin/</code> to denote that they are separate from the main site, and will all want to be kept behind a login system. It would be rather easy to forget either of these things, and risk exposing admin capabilities to the public.</p>
<p>Luckily, Flask provides a solution to both of these matters - Blueprints. A Flask Blueprint is a way of grouping together sections of a website under a common name. These sections can all contain a common URL prefix, and can have guards implemented before a request completes. We can use these two features to ensure that all of our admin functionality lives at <code>/admin/*</code> and is behind a login system.</p>
<p>Let’s begin by creating a folder in the root of our project called <code>web</code>. This will serve as the store for all things related to the web interface for our shop. Inside this folder create two more - <code>views</code> and <code>blueprints</code>. Inside <code>blueprints</code> create an <code>__init__.py</code> file:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Blueprint</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>site_blueprint <span class="op">=</span> Blueprint(<span class="st">&quot;site&quot;</span>, <span class="va">__name__</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>admin_blueprint <span class="op">=</span> Blueprint(<span class="st">&quot;admin&quot;</span>, <span class="va">__name__</span>, url_prefix<span class="op">=</span><span class="st">&quot;/admin&quot;</span>)</span></code></pre></div>
<p>We import the <code>Blueprints</code> class from <code>flask</code> and create two instances, <code>site_blueprint</code> and <code>admin_blueprint</code>. The first argument will be the name of the blueprint, which you will see used later when we use Flask’s <code>url_for</code> helper. The second argument is <code>__name__</code> by convention. Our admin blueprint has a third argument, <code>url_prefix</code>. This is used to ensure that all URLs for this blueprint begin with <code>/admin/</code> automatically.</p>
<p>Let’s create some placeholder routes for our admin section. We’ll start with an index and a login page. Inside your <code>web/views</code> folder, create two more - <code>site</code> and <code>admin</code>. This is where our URL routes will lie (Flask calls them “views”, but personally I think the term “routes” is clearer. I will stick with Flask’s terminology for our project, however).</p>
<p>Inside both <code>site</code> and <code>admin</code> create a file named <code>__init__.py</code>. This is where our guards will live. The public site needs no guards, but the admin will need to make sure a user is logged in before displaying a page.</p>
<p>Inside your new <code>admin</code> folder create a file named <code>admin.py</code> containing the following:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.blueprints <span class="im">import</span> admin_blueprint</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> admin_index():</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;Welcome to the admin&quot;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/login&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>])</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> admin_login():</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;please log in&quot;</span></span></code></pre></div>
<p>Here are our two placeholder views. As you can see, blueprints have routes added to them using the same decorator syntax as we have in our <code>web_server.py</code> file. We create a function named <code>admin_index</code> which serves as the entry-point to our admin section. The route <code>"/"</code> will combine with the <code>url_prefix</code> we specified on the Blueprint so that this page rests on <code>/admin</code>. Similarly, our <code>admin_login</code> route will be <code>/admin/login</code>.</p>
<p>Our login route has the <code>methods</code> argument passed to its decorator. This allows this route to be accessed by both GET and POST HTTP methods. When this argument is not provided, Flask assumes the route is meant only for GET requests, and any POST requests will be responded to with a 405 Method Not Allowed.</p>
<p>Our admin views are now in place, but before we flesh them out, let’s also pull our site routes out of <code>web_server.py</code> and into our new <code>site</code> folder.</p>
<p>Create a file at <code>web/views/site/site.py</code> and move over your views from <code>web_server.py</code>. Import <code>site_blueprint</code> at the top, and change the decorators from <code>@app</code> to <code>@site_blueprint</code>:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> abort, render_template</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.product <span class="im">import</span> Product</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.blueprints <span class="im">import</span> site_blueprint</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index():</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    products <span class="op">=</span> Product.select()</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;index.html&quot;</span>, products<span class="op">=</span>products)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.route</span>(<span class="st">&quot;/&lt;string:product_name&gt;&quot;</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_product(product_name):</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    product <span class="op">=</span> Product.get_or_none(Product.name <span class="op">==</span> product_name)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> product:</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> abort(<span class="dv">404</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;products/view_product.html&quot;</span>, price<span class="op">=</span>product.price, product_name<span class="op">=</span>product_name</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p>Great, now all of our views are in place. To avoid long chains of imports, let’s consolidate our modules. Open up <code>web/views/site/__init__.py</code> and add this:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> site</span></code></pre></div>
<p>Now do the same in <code>web/views/admin/__init__.py</code>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> admin</span></code></pre></div>
<p>Finally, create <code>web/views/__init__.py</code> and add this:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> admin, site</span></code></pre></div>
<p>Now our views are ready to be imported in <code>web_server.py</code>. Open that up and change it to the following:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>app.secret_key <span class="op">=</span> <span class="st">&quot;very secret&quot;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.views <span class="im">import</span> admin, site</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.blueprints <span class="im">import</span> site_blueprint, admin_blueprint</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>app.register_blueprint(site_blueprint)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>app.register_blueprint(admin_blueprint)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(app.url_map)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    app.run(debug<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>Now, after creating our <code>app</code> we pull in all of our views from both the <code>admin</code> and <code>site</code> sections. This causes our Blueprints to “fill up” with the required routes. Now we pull in said Blueprints and use <code>app.register_blueprint</code> to tell our main Flask app that they exist.</p>
<p>That’s it, this file is now much cleaner, and our code has become modularised. We can now keep a nice separation between the public shop and the private admin section.</p>
<p>Speaking of which, let’s go add that guard to our admin</p>
<h3 id="route-guards-in-flask">Route Guards in Flask</h3>
<p>As well as <code>route</code>, Flask Blueprints have access to other decorators which can modify the lifecycle of a web request. One such example is <code>before_request</code>, which is used to perform logic before a web request is passed to our view. We can use this to check if a user is logged in when they try to access <code>/admin</code>, and redirect them to our login page if not.</p>
<p>Before we change our code, open up a browser and go to <code>localhost:5000/admin</code>. You should see our “Welcome to the admin” placeholder message. This means you have successfully navigated to our admin section without authenticating.</p>
<p>Now open up <code>web/views/admin/__init__.py</code> and add the following:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> request, session, redirect, url_for</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.blueprints <span class="im">import</span> admin_blueprint</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> admin</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.before_request</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> admin_before_request():</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.endpoint <span class="op">!=</span> <span class="st">&quot;admin.admin_login&quot;</span>:</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&quot;logged_in&quot;</span> <span class="kw">not</span> <span class="kw">in</span> session:</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&quot;admin.admin_login&quot;</span>))</span></code></pre></div>
<p>We pull in a couple of helpers from Flask, as well as our <code>admin_blueprint</code>, then define a function under <code>@admin_blueprint.before_request</code>. This function checks Flask’s <code>request</code> object to see if the <code>endpoint</code> attribute is anything other than <code>admin.admin_login</code>. If it is, and there is not a flag called <code>"logged_in"</code> in Flask’s <code>session</code>, we force a redirect to the <code>admin.admin_login</code> endpoint.</p>
<p>Don’t worry about the endpoint naming, or Flask’s <code>session</code>, just yet. We will cover them shortly.</p>
<p>Now save this file and try once again to get to <code>localhost:5000/admin</code>. You should hopefully be redirected to <code>/admin/login</code>, and see a different placeholder message. This means our admin section is protected against unauthenticated users!</p>
<h3 id="adding-an-admin">Adding an Admin</h3>
<p>Now that our page is guarded, we need to get ourselves a user so that we can unlock it. To achieve this we’ll need a new database table - <code>admin_users</code>. Create a new file in the <code>migrations</code> folder called <code>V2__add_admin_user_table.sql</code>:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> admin_user (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span> autoincrement, username text, <span class="kw">password</span> text);</span></code></pre></div>
<p>Run the <code>flyway/flyway migrate</code> command in your project root folder and you will now have a second table. Time for our Peewee model. Create <code>models/admin_user.py</code>:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models <span class="im">import</span> BaseModel</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playhouse.sqlite_ext <span class="im">import</span> <span class="op">*</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AdminUser(BaseModel):</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> AutoField()</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    username <span class="op">=</span> TextField()</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    password <span class="op">=</span> TextField()</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Meta:</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        table_name <span class="op">=</span> <span class="st">&quot;admin_user&quot;</span></span></code></pre></div>
<p>Much like our <code>Product</code> class, the <code>AdminUser</code> contains an <code>id</code> field and two <code>text</code> fields.</p>
<p>Now we need an admin user, but as previously mentioned, it’s best to just use migrations for table structure, and not data. So, let’s use the Python interactive shell to make us our first admin user. Open a terminal in the root of your project, ensure your virtualenv is sourced, and run <code>python3</code>.</p>
<p>First we’ll create an <code>AdminUser</code> and assign them a username. I will use “admin”, but you can use whatever name you’d like.</p>
<pre><code>Python 3.10.0 (default, Oct  4 2021, 00:00:00) [GCC 11.2.1 20210728 (Red Hat 11.2.1-1)] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from models.admin_user import AdminUser
&gt;&gt;&gt; user = AdminUser()
&gt;&gt;&gt; user.username = &quot;admin&quot;</code></pre>
<p>Now our user needs a password. Since it’s bad security practise to store password in plain-text, we will store our password as a hash. Flask itself is built upon a library known as <code>werkzeug</code> which provides functions for securely hashing and checking passwords. For example, to hash the password “admin”:</p>
<pre><code>&gt;&gt;&gt; from werkzeug.security import generate_password_hash
&gt;&gt;&gt; generate_password_hash(&#39;admin&#39;)
&#39;pbkdf2:sha256:260000$aOwDEpVMd5aO0oie$2916af44ac8b1e79d8a1ac74882f1602da2bae33fc690491c5014fe98f186ed4&#39;</code></pre>
<p>Pick a nice password for your admin user, and set the hash of this password as the <code>AdminUser</code>’s <code>password</code> attribute:</p>
<pre><code>&gt;&gt;&gt; user.password = generate_password_hash(&quot;admin&quot;)</code></pre>
<p>Now we can write this row to our database with <code>save()</code>:</p>
<pre><code>&gt;&gt;&gt; user.save()
1</code></pre>
<p>And we can confirm the record is now in our database:</p>
<pre><code>&gt;&gt;&gt; u = AdminUser.get()
&gt;&gt;&gt; u.username
&#39;admin&#39;
&gt;&gt;&gt; u.password
&#39;pbkdf2:sha256:260000$O0eSD3qnpfXpqVYn$4ca214264ba24b66ffc01b5ec801d50314439f24e947df03d4f763d4a58e5704&#39;
&gt;&gt;&gt; </code></pre>
<h4 id="logging-in">Logging in</h4>
<p>With an admin user created, we can now create a simple login screen and update our view accordingly. Create a folder named <code>admin</code> in your <code>templates</code> folder, then create two files inside of it - <code>login.html</code> and <code>index.html</code>.</p>
<p>Let’s start with our login form, so open up <code>login.html</code>:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Log in<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>{% for msg in get_flashed_messages() %}</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h2</span> <span class="er">style</span><span class="ot">=</span><span class="st">&quot;color:red&quot;</span><span class="kw">&gt;</span>{{msg}}<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>{% endfor %}</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr</span> <span class="kw">/&gt;</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;form</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;login_form&quot;</span> <span class="er">method</span><span class="ot">=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;label</span> <span class="er">for</span><span class="ot">=</span><span class="st">&quot;username&quot;</span><span class="kw">&gt;</span>Username<span class="kw">&lt;/label&gt;</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;text&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;username&quot;</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;username&quot;</span><span class="kw">&gt;</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br</span> <span class="kw">/&gt;</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br</span> <span class="kw">/&gt;</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;label</span> <span class="er">for</span><span class="ot">=</span><span class="st">&quot;password&quot;</span><span class="kw">&gt;</span>Password<span class="kw">&lt;/label&gt;</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;password&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;password&quot;</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;password&quot;</span><span class="kw">&gt;</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br</span> <span class="kw">/&gt;</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br</span> <span class="kw">/&gt;</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;submit&quot;</span> <span class="er">value</span><span class="ot">=</span><span class="st">&quot;Log In&quot;</span><span class="kw">&gt;</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/form&gt;</span></span></code></pre></div>
<p>This is mostly a standard HTML form. At the top you will notice a call to <code>get_flashed_messages</code>. Flash messages are simply a short message which should be viewed only once by the user. They are typically used to convey the success or failure of a single action. We use a <code>style</code> attribute to colour ours red, since it will only show when the login attempt is unsuccessful.</p>
<p>Now we have the template, let’s get our view rendering it. Open up <code>web/views/admin/admin.py</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> request, session, redirect, url_for, render_template, flash</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> werkzeug.security <span class="im">import</span> check_password_hash</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.admin_user <span class="im">import</span> AdminUser</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.blueprints <span class="im">import</span> admin_blueprint</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> admin_index():</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;admin/index.html&quot;</span>)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/login&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>])</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> admin_login():</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>:</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>        username <span class="op">=</span> request.form.get(<span class="st">&quot;username&quot;</span>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        password <span class="op">=</span> request.form.get(<span class="st">&quot;password&quot;</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> AdminUser.get_or_none(AdminUser.username <span class="op">==</span> username)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> user:</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>            password_correct <span class="op">=</span> check_password_hash(user.password, password)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> password_correct:</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>                session[<span class="st">&quot;logged_in&quot;</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>                session[<span class="st">&quot;admin_user_id&quot;</span>] <span class="op">=</span> user.<span class="bu">id</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> redirect(url_for(<span class="st">&quot;admin.admin_index&quot;</span>))</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>                flash(<span class="st">&quot;Please try again!&quot;</span>)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">&quot;Please try again&quot;</span>)</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;admin/login.html&quot;</span>)</span></code></pre></div>
<p>We add a couple of new imports from <code>flask</code>, our old friend <code>render_template</code> and the new <code>flash</code> function to display the aforementioned flash messages.</p>
<p>The <code>check_password_hash</code> function is brought in from <code>werkzeug</code> so that we can test the password hash from our new <code>AdminUser</code> instance.</p>
<p>Our <code>admin_index</code> function is changed to render a template rather than returning a string.</p>
<p>The <code>admin_login</code> route is now fully fleshed-out. We begin by checking the <code>method</code> of our <code>request</code> object so that we can tell whether we are on the initial page-load (a GET request) or if we have the data from our form submitted (a POST request). If we have a POST request, we use the <code>form</code> attribute of our <code>request</code> object to extract the POSTed data. The <code>get</code> method acts like it does for a normal dict, it returns the value if present, or <code>None</code> if not.</p>
<p>To validate the credentials, we try and grab an <code>AdminUser</code> from our table by matching on the <code>username</code>. If we have a user with this username, we then use <code>check_password_hash</code>, passing the <code>AdminUser</code>’s stored password and the password supplied by the form. If the passwords match then the submitted details are both correct, and we can log the user in. We achieve this by setting the <code>"logged_in"</code> session variable, and also store the <code>AdminUser</code>’s ID, then redirect the user off to the index.</p>
<p>If the username was not found, or the passwords did not match, the <code>flash</code> function is used to display an error message, and the <code>login.html</code> template will be rendered once again.</p>
<p>Before we can test this, let’s put a heading into <code>admin/index.html</code> so that we can see when we’re logged in successfully:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Welcome to the admin!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>You are logged in<span class="kw">&lt;/p&gt;</span></span></code></pre></div>
<p>Re-run your <code>web_server.py</code> file and head over to <code>http://localhost:5000/admin</code>. You should get redirected to the login form.</p>
<p>First try entering incorrect details in to have a look at the <code>flash</code> message. Then put in your correct login details and see yourself sent back to the index page. Hooray!</p>
<h4 id="editing-data">Editing Data</h4>
<p>Now that our admin page is guarded by the login system, we can start adding the functionality to create, read, update, and delete our database records. This is often referred to by the acronym CRUD.</p>
<p>Let’s start with “read” by showing a list of <code>Product</code>s on the admin index. Change your view to the following:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> admin_index():</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    all_products <span class="op">=</span> Product.select().order_by(Product.name.asc())</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;admin/index.html&quot;</span>, all_products<span class="op">=</span>all_products)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p>We are passing a generator of all products, ordered by their <code>name</code> attribute, to our template. Now let’s display them on <code>admin/index.html</code>:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Welcome to the admin!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr</span> <span class="kw">/&gt;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2&gt;</span>All Products<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;br</span> <span class="kw">/&gt;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;table&gt;</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;thead&gt;</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Name<span class="kw">&lt;/th&gt;</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Price<span class="kw">&lt;/th&gt;</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Actions<span class="kw">&lt;/th&gt;</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/thead&gt;</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;tbody&gt;</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    {% for product in all_products %}</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;/admin/{{product.id}}&quot;</span><span class="kw">&gt;</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>                    {{product.name|title}}</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;/a&gt;</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;/td&gt;</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>                £{{&quot;%.2f&quot;|format(product.price|float)}}</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;/td&gt;</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;button</span> <span class="er">onclick</span><span class="ot">=</span><span class="st">&quot;deleteProduct({{product.id}})&quot;</span><span class="kw">&gt;</span>Delete<span class="kw">&lt;/button&gt;</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;/td&gt;</span></span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/li&gt;</span></span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    {% endfor %}</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/tbody&gt;</span></span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/table&gt;</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script&gt;</span></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">deleteProduct</span>(productId) {</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;deleting product&quot;</span><span class="op">,</span> productId)<span class="op">;</span></span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/script&gt;</span></span></code></pre></div>
<p>After our welcome message we display a table of all available products, showing their name, price, and some actions. Clicking a product’s name will take you to its update page (which we will create next), and each product has a “Delete” button which we can use later to remove a product from our database.</p>
<p>For the moment, this button will just log the clicked product’s ID to the javascript console.</p>
<p>Reload your admin index and you should see your table with your three products listed.</p>
<p>Let’s start by building the edit page, so we can click on those product names. Create a new template file <code>templates/admin/products/edit_product.html</code>:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Edit {{product.name}}<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr&gt;</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;form</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;product_form&quot;</span> <span class="er">action</span><span class="ot">=</span><span class="st">&quot;{{url_for(&#39;admin.save_product&#39;)}}&quot;</span> <span class="er">method</span><span class="ot">=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;hidden&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;product_id&quot;</span> <span class="er">value</span><span class="ot">=</span><span class="st">&quot;{{product.id}}&quot;</span><span class="kw">&gt;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;label</span> <span class="er">for</span><span class="ot">=</span><span class="st">&quot;name&quot;</span><span class="kw">&gt;</span>Name:<span class="kw">&lt;/label&gt;</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;text&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;name&quot;</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;name&quot;</span> <span class="er">value</span><span class="ot">=</span><span class="st">&quot;{{product.name}}&quot;</span><span class="kw">&gt;</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;label</span> <span class="er">for</span><span class="ot">=</span><span class="st">&quot;price&quot;</span><span class="kw">&gt;</span>Price:<span class="kw">&lt;/label&gt;</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;text&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;price&quot;</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;price&quot;</span> <span class="er">value</span><span class="ot">=</span><span class="st">&quot;{{product.price}}&quot;</span><span class="kw">&gt;</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;submit&quot;</span> <span class="er">value</span><span class="ot">=</span><span class="st">&quot;Save&quot;</span><span class="kw">&gt;</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/form&gt;</span></span></code></pre></div>
<p>A basic HTML form with two text inputs, one for the product’s name and one for its price. We also have a hidden input which will send this product’s ID.</p>
<p>We can’t use this page yet, as the <code>admin.save_product</code> view doesn’t exist yet, so hop back over to <code>views/admin/admin.py</code>:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/&lt;int:product_id&gt;&quot;</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> edit_product(product_id: <span class="bu">int</span>):</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    product <span class="op">=</span> Product.get_or_none(Product.<span class="bu">id</span> <span class="op">==</span> product_id)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> product:</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">&quot;Product not found&quot;</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&quot;admin.admin_index&quot;</span>))</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;admin/products/edit_product.html&quot;</span>, product<span class="op">=</span>product)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/save-product&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_product():</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    product <span class="op">=</span> Product()</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    product_id <span class="op">=</span> request.form.get(<span class="st">&quot;product_id&quot;</span>)</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> product_id:</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>        product <span class="op">=</span> Product.get_or_none(Product.<span class="bu">id</span> <span class="op">==</span> product_id)</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> product:</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">&quot;admin.admin_index&quot;</span>))</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> request.form.get(<span class="st">&quot;name&quot;</span>)</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> request.form.get(<span class="st">&quot;price&quot;</span>)</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    product.name <span class="op">=</span> name</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    product.price <span class="op">=</span> price</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    product.save()</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> redirect(url_for(<span class="st">&quot;admin.edit_product&quot;</span>, product_id<span class="op">=</span>product.<span class="bu">id</span>))</span></code></pre></div>
<p>First our <code>edit_product</code> view. This view takes a product ID from the URL and makes sure it is an integer. We then use Peewee to try and fetch a product with this ID from the database. If it’s not found, we send the user back to the admin index, since we can’t show its form. If we find it, we then render the <code>edit_form.html</code> template, passing the product as context.</p>
<p>The <code>save_product</code> view begins by creating a new <code>Product</code> instance. This will allow us to re-use this view later when we build the “create” functionality. If a <code>product_id</code> is passed in our POST data, then the blank product is replaced by the result of a <code>get_or_none</code> on the provided ID. If no product is found, we return the user to the admin index.</p>
<p>Once we have our <code>Product</code> instance, we can get the POSTed data from the <code>request.form</code> object and assign the values to the instance’s <code>name</code> and <code>price</code> attributes. We then call <code>save()</code> to write the changes to our database, before reloading the <code>edit_product</code> page.</p>
<p>Your site should be in working condition now, so go ahead and restart your <code>web_server.py</code> command and view <code>http://localhost:8080/admin</code> in your browser. After logging in, click a product’s name and you’ll see its edit form. Try changing the name and price and pressing Save. You should see your changes persist after saving, and back on the admin index page.</p>
<p>Groovy! Now let’s add the “create” functionality. Put this very simple new view into <code>views/admin/admin.py</code>:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/create-product&quot;</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_product():</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;/admin/products/create_product.html&quot;</span>)</span></code></pre></div>
<p>And now create yourself a template at <code>templates/admin/products/create_product.html</code>:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1&gt;</span>Create a Product<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr&gt;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;form</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;product_form&quot;</span> <span class="er">action</span><span class="ot">=</span><span class="st">&quot;{{url_for(&#39;admin.save_product&#39;)}}&quot;</span> <span class="er">method</span><span class="ot">=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;label</span> <span class="er">for</span><span class="ot">=</span><span class="st">&quot;name&quot;</span><span class="kw">&gt;</span>Name:<span class="kw">&lt;/label&gt;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;text&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;name&quot;</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;name&quot;</span><span class="kw">&gt;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;label</span> <span class="er">for</span><span class="ot">=</span><span class="st">&quot;price&quot;</span><span class="kw">&gt;</span>Price:<span class="kw">&lt;/label&gt;</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;text&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;price&quot;</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;price&quot;</span><span class="kw">&gt;</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br/&gt;</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;submit&quot;</span> <span class="er">value</span><span class="ot">=</span><span class="st">&quot;Save&quot;</span><span class="kw">&gt;</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/form&gt;</span></span></code></pre></div>
<p>This should look familiar, since it’s mostly just the <code>edit_form</code> again, but without the hidden input or <code>value</code> attributes.</p>
<p>Now we need a link to this on our index, so open up <code>templates/admin/index.html</code> and add this below your table:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;hr</span> <span class="kw">/&gt;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;{{url_for(&#39;admin.create_product&#39;)}}&quot;</span><span class="kw">&gt;</span>Create new Product<span class="kw">&lt;/a&gt;</span></span></code></pre></div>
<p>Reload your admin index and try clicking on this link. You should be greeted with a blank form. Fill it in and create yourself a new product. After saving, your product should appear on the admin index amongst the others. Neat!</p>
<p>Just one step left now - “delete”. Still in your admin index template, alter the <code>deleteProduct</code> javascript function at the bottom to the following:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">function</span> <span class="fu">deleteProduct</span>(productId) {</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> fd <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>()<span class="op">;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        fd<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;product_id&#39;</span><span class="op">,</span> productId)<span class="op">;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;{{url_for(&quot;admin.delete_product&quot;)}}&#39;</span><span class="op">,</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>                <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>                <span class="dt">body</span><span class="op">:</span> fd<span class="op">,</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>            } </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> res_json <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">alert</span>(res_json<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>        location<span class="op">.</span><span class="fu">reload</span>()<span class="op">;</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p>This function uses the <code>fetch</code> syntax to send a POST request to the <code>admin.delete_product</code> view containing form data with the selected product’s ID. That view doesn’t exist yet, so open up <code>views/admin/admin.py</code> for one final time and add the following:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="at">@admin_blueprint.route</span>(<span class="st">&quot;/delete-product&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delete_product():</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    product_id <span class="op">=</span> request.form.get(<span class="st">&quot;product_id&quot;</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    product <span class="op">=</span> Product.get_or_none(Product.<span class="bu">id</span> <span class="op">==</span> product_id)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> product:</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;success&quot;</span>: <span class="va">False</span>, <span class="st">&quot;message&quot;</span>: <span class="st">&quot;Product not found&quot;</span>}, <span class="dv">400</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    Product.delete().where(Product.<span class="bu">id</span> <span class="op">==</span> product_id).execute()</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;success&quot;</span>: <span class="va">True</span>, <span class="st">&quot;message&quot;</span>: <span class="st">&quot;Product Deleted&quot;</span>}</span></code></pre></div>
<p>This view grabs the <code>product_id</code> from the POST data and uses it to fetch a matching <code>Product</code> instance. If not successful, an error response is returned (the <code>400</code> after the JSON is the HTTP status code of the request). If the product <em>was</em> found Peewee’s <code>delete().where().execute()</code> functionality is used to delete the product from our database.</p>
<p>Reload your <code>web_server</code> and site then give one of those delete buttons a whack. You should see a popup saying “Product Deleted” and the page should update with the product no longer in your table.</p>
<p>Great - that’s all parts of the CRUD functionality completed! With this out of the way, we can now go on to the most important part of any shop - the ability to make sales.</p>
<h1 id="chapter-5">Chapter 5</h1>
<h2 id="adding-purchase-abilities">Adding Purchase Abilities</h2>
<p>Now that we have the ability to create products to list on our shop, let’s add the ability for a customer to purchase them. We’ll create a Cart which the visitor can use to store items, then a Checkout page where they can enter an email address to complete their order.</p>
<h3 id="creating-a-cart">Creating a Cart</h3>
<p>We can use Flask’s <code>session</code> capabilities to give each user a Cart which will follow them around the site. The <code>session</code> is essentially just a regular python <code>dict</code> which will be stored as an encrypted cookie in the user’s browser, and thus will be available in every request they make. This allows us to store data semi-permanently against each individual user.</p>
<p>To use Flask’s <code>session</code> we simply import it and start assigning values. We have seen this in action when creating our login system for the admin.</p>
<p>Let’s now display our cart on the site. Open up <code>templates/base.html</code> and change the contents of the <code>&lt;body&gt;</code> tag to the following:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;body&gt;</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;h1&gt;</span>Welcome to my shop!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;hr&gt;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>        Items in Cart: <span class="kw">&lt;span</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;cart-items&quot;</span><span class="kw">&gt;</span>{{cart|length}}<span class="kw">&lt;/span&gt;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;/checkout&quot;</span><span class="kw">&gt;</span>Checkout<span class="kw">&lt;/a&gt;</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;hr&gt;</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        {% block content %}</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        {% endblock%}</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>Now the number of items in our cart will display underneath our header. Let’s create and pass a Cart through in our index page.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> ..., session</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index():</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    products <span class="op">=</span> Product.select()</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&quot;cart&quot;</span> <span class="kw">not</span> <span class="kw">in</span> session:</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        session[<span class="st">&quot;cart&quot;</span>] <span class="op">=</span> <span class="st">&quot;1&quot;</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;index.html&quot;</span>, products<span class="op">=</span>products, cart<span class="op">=</span>cart)</span></code></pre></div>
<p>Reload your site’s index page and you should see “Items in Cart: 1” at the top, as well as a link to a checkout page. Now try changing the <code>"1"</code> to <code>"123"</code> and you should see “Items in Cart: 3”.</p>
<p>Great, now we can keep track of the number of items in our Cart. However, if you load another page, you’ll get an error from Jinja because <code>cart</code> is missing. To avoid having to remember to pass this variable in every single view, let’s create a global template context for our site views, so we will always have our <code>cart</code>.</p>
<h4 id="global-jinja-context">Global Jinja Context</h4>
<p>Open up <code>views/site/__init__.py</code> and change it to this:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> . <span class="im">import</span> site</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.blueprints <span class="im">import</span> site_blueprint</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.context_processor</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inject_variables():</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> flask <span class="im">import</span> session</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&quot;cart&quot;</span> <span class="kw">not</span> <span class="kw">in</span> session:</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>        session[<span class="st">&quot;cart&quot;</span>] <span class="op">=</span> []</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;cart&quot;</span>: session[<span class="st">&quot;cart&quot;</span>]}</span></code></pre></div>
<p>Here we use the <code>context_processor</code> decorator to inject variables into all templates under the <code>site_blueprint</code>. This function grabs the <code>session</code> from Flask and adds an empty list named <code>"cart"</code> if it doesn’t already exist. Then it returns a dictionary, which will be the default context for any templates using Flask’s <code>render_template</code> function within this blueprint.</p>
<p>Save this and open a product page on your site. You should now still see your Cart items in the header. Now we can remove the Cart-related code from our <code>index</code> view again.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.route</span>(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index():</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    products <span class="op">=</span> Product.select()</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;index.html&quot;</span>, products<span class="op">=</span>products)</span></code></pre></div>
<h4 id="adding-to-cart">Adding To Cart</h4>
<p>Now we have a Cart, let’s get items added. Firstly, we’ll need to clear the string-version of our session variable. If you know how, clear the cookies for <code>localhost</code> on your browser. If you don’t, you can add the line <code>session["cart"] = []</code> to your <code>index</code> view, load the index page, then remove the line.</p>
<p>With that taken care of, open up <code>templates/products/view_product.html</code> and change your <code>content</code> block to the following:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h2&gt;</span>{{product.name}}<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>This product costs £{{&quot;%.2f&quot;|format(product.price|float)}}<span class="kw">&lt;/p&gt;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;button</span> <span class="er">onclick</span><span class="ot">=</span><span class="st">&quot;addToCart({{product.id}})&quot;</span><span class="kw">&gt;</span>Add to Cart<span class="kw">&lt;/button&gt;</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script&gt;</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">function</span> <span class="fu">addToCart</span>(productId) {</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> fd <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>()<span class="op">;</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>        fd<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;product_id&#39;</span><span class="op">,</span> productId)<span class="op">;</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;{{url_for(&quot;site.add_product_to_cart&quot;)}}&#39;</span><span class="op">,</span> </span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>                <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;POST&#39;</span><span class="op">,</span> </span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>                <span class="dt">body</span><span class="op">:</span> fd<span class="op">,</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> res_json <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> cartItems <span class="op">=</span> res_json<span class="op">.</span><span class="at">cart_items</span><span class="op">;</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;cart-items&quot;</span>)<span class="op">.</span><span class="at">innerText</span> <span class="op">=</span> cartItems<span class="op">;</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/script&gt;</span></span></code></pre></div>
<p>We’re adding a button underneath our product’s information which will add this product to our Cart. This is achieved using an <code>onClick</code> function called <code>addToCart</code> which will call some javascript to send a request to our backend.</p>
<p>The <code>addToCart</code> function creates a <code>FormData</code> object to wrap up our chosen Product’s ID and then POSTs it to a new endpoint called <code>add_product_to_cart</code> using <code>fetch</code>. The server’s response is then parsed and we update the count of our Cart items using the value returned as <code>cart_items</code>.</p>
<p>Let’s create this new endpoint now. Open up <code>views/site/site.py</code> and add the following:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.route</span>(<span class="st">&quot;/add-product-to-cart&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_product_to_cart():</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    product_id <span class="op">=</span> request.form.get(<span class="st">&quot;product_id&quot;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> product_id:</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;success&quot;</span>: <span class="va">False</span>, <span class="st">&quot;cart_items&quot;</span>: <span class="bu">len</span>(session[<span class="st">&quot;cart&quot;</span>])}</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    current_cart <span class="op">=</span> session[<span class="st">&quot;cart&quot;</span>]</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    current_cart.append(product_id)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    session[<span class="st">&quot;cart&quot;</span>] <span class="op">=</span> current_cart</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;success&quot;</span>: <span class="va">True</span>, <span class="st">&quot;cart_items&quot;</span>: <span class="bu">len</span>(session[<span class="st">&quot;cart&quot;</span>])}</span></code></pre></div>
<p>In this endpoint we check <code>request.form</code> for the <code>product_id</code> sent by our Javascript’s <code>FormData</code> object and parse it as an integer using <code>type=int</code>. If it isn’t found, we return an unsuccessful response which does not change the items in the Cart.</p>
<p>If the product <em>is</em> found we can then add its ID to our Cart. We do this by copying the cart from our session into a <code>current_cart</code> temporary list, appending the Product’s ID to it, then assigning this back to the session’s Cart.</p>
<p>We then return a successful response which includes the <code>cart_items</code> key which the Javascript can use to update the count in our header.</p>
<p>With this new endpoint in place, go ahead and load a product page in your browser. Click the “Add to Cart” button a few times and see your “Items in Cart” heading increase. Navigate to another Product page and see your Cart’s status follow you around.</p>
<p>Great! Now we have a working Cart, so let’s add a way for a user to Checkout.</p>
<h3 id="checking-out">Checking Out</h3>
<p>When checking out, we will display all of the items in our user’s Cart and sum up the total price. There will then be a place for the user to enter their email address and complete the purchase. In a <em>real</em> online-shop this would be where the user makes an account and enters their payment information, but we’ve already learned about account creation, and taking payments is out of scope for this book.</p>
<p>We’ll need a new database table for storing any completed orders, so let’s go ahead and create that now. Make a file in your <code>migrations</code> folder called <code>V3__add_order_table.sql</code> containing the following:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> <span class="ot">&quot;order&quot;</span> (<span class="kw">id</span> <span class="dt">integer</span> <span class="kw">primary</span> <span class="kw">key</span> autoincrement, timestamp_created string, email string, products string);</span></code></pre></div>
<p>Here <code>"order"</code> is in double-quotes because it is a reserved word in SQL.</p>
<p>Run <code>flyway/flyway migrate</code> to create yourself a new table. Now we’ll need the Peewee model, too. Make a file in your <code>models</code> folder called <code>order.py</code> and add this new class:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models <span class="im">import</span> BaseModel</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playhouse.sqlite_ext <span class="im">import</span> <span class="op">*</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Order(BaseModel):</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> AutoField()</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    timestamp_created <span class="op">=</span> DateTimeField()</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    email <span class="op">=</span> TextField()</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    products <span class="op">=</span> JSONField()</span></code></pre></div>
<p>We haven’t seen <code>DateTimeField</code> or <code>JSONField</code> yet. These are used to tell Peewee that the string values in the database can be interpreted as <code>datetime</code> objects or <code>json</code> dicts, respectively. The data in SQLite will remain a regular string, however.</p>
<p>Now that we can store a record of our orders, we’re in position to add the functionality to our shop. Let’s create a new view in our <code>views/site/site.py</code> file for checking out:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.route</span>(<span class="st">&quot;/checkout&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;GET&quot;</span>, <span class="st">&quot;POST&quot;</span>])</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> checkout():</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    cart_items <span class="op">=</span> []</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    cart_products <span class="op">=</span> {}</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    total_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> product_id <span class="kw">in</span> session[<span class="st">&quot;cart&quot;</span>]:</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> Product.get_or_none(Product.<span class="bu">id</span> <span class="op">==</span> product_id)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p.name <span class="kw">not</span> <span class="kw">in</span> cart_products:</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>            cart_products[p.name] <span class="op">=</span> {<span class="st">&quot;total&quot;</span>: <span class="bu">float</span>(p.price), <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>}</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>            cart_products[p.name][<span class="st">&quot;total&quot;</span>] <span class="op">+=</span> <span class="bu">float</span>(p.price)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>            cart_products[p.name][<span class="st">&quot;quantity&quot;</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, price_info <span class="kw">in</span> cart_products.items():</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>        cart_items.append(</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;name&quot;</span>: name,</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;quantity&quot;</span>: price_info[<span class="st">&quot;quantity&quot;</span>],</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;total_price&quot;</span>: price_info[<span class="st">&quot;total&quot;</span>],</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>        total_price <span class="op">+=</span> price_info[<span class="st">&quot;total&quot;</span>]</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;checkout.html&quot;</span>, cart_items<span class="op">=</span>cart_items, total_price<span class="op">=</span>total_price</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p>There’s quite a lot of logic here, but it’s mostly just processing the Cart items into a user-readable format.</p>
<p>We create three variables called <code>cart_items</code>, <code>cart_products</code> and <code>total_price</code>. Next we loop through all of the Product IDs in our Cart and fetch the <code>Product</code> instance for each.</p>
<p>If we haven’t come across this Product before we create a <code>dict</code> inside of <code>cart_products</code> which pairs the Product’s <code>name</code> to another <code>dict</code> of its <code>price</code> and a <code>quantity</code> of 1. If we already have this product in our <code>cart_products</code> we simply increase the total price by its unit cost and increase the quantity by one.</p>
<p>Once we’ve built up this mapping of Produt names to price info, we can loop through our <code>cart_products</code> and append a <code>dict</code> displaying the information to our <code>cart_items</code> list, as well as summing up the cost of each Product in our <code>total_price</code> variable.</p>
<p>With the data processed, we can then pass our <code>cart_items</code> and <code>total_price</code> variables to a new template. Speaking of which, let’s create <code>templates/checkout.html</code> now:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>{% extends &quot;base.html&quot; %}</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>{% block content %}</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>Checkout<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;hr&gt;</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;table&gt;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Product<span class="kw">&lt;/th&gt;</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Quantity<span class="kw">&lt;/th&gt;</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Total<span class="kw">&lt;/th&gt;</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>        {% for item in cart_items %}</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;tr&gt;</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;td&gt;</span>{{item.name}}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;td&gt;</span>{{item.quantity}}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;td&gt;</span>£{{&quot;%.2f&quot;|format(item.total_price)}}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>        {% endfor %}</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span>-<span class="kw">&lt;/td&gt;</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span>-<span class="kw">&lt;/td&gt;</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span>-<span class="kw">&lt;/td&gt;</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;&lt;b&gt;</span>Total<span class="kw">&lt;/b&gt;&lt;/td&gt;</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;&lt;/td&gt;</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;&lt;b&gt;</span>£{{&quot;%.2f&quot;|format(total_price)}}<span class="kw">&lt;/b&gt;&lt;/td&gt;</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/table&gt;</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>{% endblock %}</span></code></pre></div>
<p>In this template we can loop through our <code>cart_items</code> and display them neatly in a table. At the bottom of the table, we add a row full of dashes as a separator, then the total price in bold.</p>
<p>If you want to make the table look a bit nicer, you can add the following styles above your <code>h1</code> heading:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;style&gt;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>        table {</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border-collapse</span>: <span class="dv">collapse</span><span class="op">;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>        table tr td {</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">border</span>: <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">black</span><span class="op">;</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">text-align</span>: <span class="dv">center</span><span class="op">;</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">padding</span>: <span class="dv">8</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/style&gt;</span></span></code></pre></div>
<p>Load up your shop and add some items to your Cart, then click the “Checkout” link in the header. You should see a nice breakdown of all items in your Cart, and a total price at the bottom.</p>
<p>Now we need a way for the purchase to complete, so add the following underneath your table:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br&gt;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;hr&gt;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h2&gt;</span>Complete your Purchase<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;form</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;checkout-form&quot;</span> <span class="er">method</span><span class="ot">=</span><span class="st">&quot;POST&quot;</span><span class="kw">&gt;</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;label</span> <span class="er">for</span><span class="ot">=</span><span class="st">&quot;email&quot;</span><span class="kw">&gt;</span>Email Address<span class="kw">&lt;/label&gt;</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;email&quot;</span> <span class="er">name</span><span class="ot">=</span><span class="st">&quot;email&quot;</span><span class="kw">&gt;</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;br&gt;</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;br&gt;</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;input</span> <span class="er">type</span><span class="ot">=</span><span class="st">&quot;submit&quot;</span> <span class="er">value</span><span class="ot">=</span><span class="st">&quot;Checkout&quot;</span><span class="kw">&gt;</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/form&gt;</span></span></code></pre></div>
<p>This will add a form which takes the user’s email address. We’ll now need to process this on the server, so head back to <code>views/site/site.py</code> and add the following lines just above your <code>return</code> statement:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">&quot;POST&quot;</span>:</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>        user_email <span class="op">=</span> request.form.get(<span class="st">&quot;email&quot;</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>        order <span class="op">=</span> Order()</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        order.email <span class="op">=</span> user_email</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        order.products <span class="op">=</span> cart_products</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        order.timestamp_created <span class="op">=</span> datetime.now().strftime(<span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S&quot;</span>)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        order.save()</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        session[<span class="st">&quot;recent_order_id&quot;</span>] <span class="op">=</span> order.<span class="bu">id</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&quot;site.complete&quot;</span>))</span></code></pre></div>
<p>Then add an import at the top of the file:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span></code></pre></div>
<p>On a POST request, generated by a user submitting the form, we grab the provided <code>email</code> from <code>request.form</code> and create an instance of our <code>Order</code> class. This order is populated with the email address, our <code>cart_products</code> <code>dict</code>, and the current date and time.</p>
<p>The ID assigned to the order is then saved to the <code>session</code> and we redirect to the <code>site.complete</code> endpoint, which we can write now:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="at">@site_blueprint.route</span>(<span class="st">&quot;/complete&quot;</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> complete():</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&quot;recent_order_id&quot;</span> <span class="kw">not</span> <span class="kw">in</span> session:</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">&quot;site.index&quot;</span>))</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> Order.get_or_none(Order.<span class="bu">id</span> <span class="op">==</span> session[<span class="st">&quot;recent_order_id&quot;</span>])</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    session.pop(<span class="st">&quot;recent_order_id&quot;</span>)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    session[<span class="st">&quot;cart&quot;</span>] <span class="op">=</span> []</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;complete.html&quot;</span>, order<span class="op">=</span>order)</span></code></pre></div>
<p>If there’s no recent order we just redirect the user back to the index, as there’s no use for this page. Otherwise, we fetch the order details from our database using the ID we saved in the <code>session</code>, then remove the <code>recent_order_id</code> using <code>pop</code> and clear out the user’s Cart.</p>
<p>Our <code>templates/complete.html</code> template will be as follows:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>{% extends &quot;base.html&quot; %}</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>{% block content %}</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>Order Complete!<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;hr&gt;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h2&gt;</span>Thanks for your order!<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;br&gt;</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h3&gt;</span>Confirmation will be sent to {{order.email}}<span class="kw">&lt;/h3&gt;</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;hr&gt;</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;table&gt;</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Product<span class="kw">&lt;/th&gt;</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Quantity<span class="kw">&lt;/th&gt;</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;th&gt;</span>Price<span class="kw">&lt;/th&gt;</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>        {% for name, price_info in order.products.items() %}</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;tr&gt;</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;td&gt;</span>{{name}}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;td&gt;</span>{{price_info[&quot;quantity&quot;]}}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>                <span class="kw">&lt;td&gt;</span>£{{&quot;%.2f&quot;|format(price_info[&quot;total&quot;])}}<span class="kw">&lt;/td&gt;</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>        {% endfor %}</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/table&gt;</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;hr&gt;</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;/&quot;</span><span class="kw">&gt;</span>Continue Shopping<span class="kw">&lt;/a&gt;</span></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>{% endblock %}</span></code></pre></div>
<p>The <code>complete.html</code> template simply thanks the user for their order, notifies them about incoming email confirmation, and renders the same table of their purchased products as the Checkout page.</p>
<p>Load up your shop in your browser and visit the Checkout page again. Enter something into the email input at the bottom and press the “Checkout” buton. You should see the confirmation of your purchase.</p>
<p>That’s it for our online shop! We’ve now got a Cart which follows the user around between page-loads, and a checkout system which collects and stores orders along with the customer’s email address.</p>
<p>The next chapter will focus on writing some more automated tests for this new functionality to ensure it always works as expected.</p>
<h1 id="chapter-6">Chapter 6</h1>
<h2 id="more-testing">More Testing</h2>
<p>Now that our admin and site are fully-functional, we should add some automated tests to ensure that our site’s core functionality will still work as we add features in the future.</p>
<p>We’ll start with our admin section, since we need to ensure it’s only available when a user is logged in.</p>
<h3 id="testing-the-admin">Testing the Admin</h3>
<p>As we have two distinct parts to our site, we should split our test suite up to match. Create two folders in your <code>tests</code> folder - <code>site</code> and <code>admin</code>. Then move your <code>test_index.py</code> file into <code>site</code> and rename it to <code>test_site.py</code>. Now create a <code>test_admin.py</code> file inside your <code>tests/admin</code> folder and add the following:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.admin_user <span class="im">import</span> AdminUser</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.product <span class="im">import</span> Product</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tests.helpers <span class="im">import</span> <span class="op">*</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tests <span class="im">import</span> testing_app</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_index_redirects_to_login_if_not_logged_in():</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="st">&quot;/admin/&quot;</span>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.status_code <span class="op">==</span> <span class="dv">302</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;/login&quot;</span> <span class="kw">in</span> res.get_data()</span></code></pre></div>
<p>This first test tries to load the <code>/admin</code> page and asserts that the response is a 302 (redirect). We also see the URL we are being sent to, and we assert that it is the <code>/login</code> page. You will notice the <code>b</code> in front of our <code>"/login"</code> string - this is because HTTP responses are bytes. You can check a response’s content with either a bytes string (like above) or by adding <code>.decode("utf-8")</code> to <code>res.get_data()</code> (as we did in chapter 3). We’ll be using bytes strings in this chapter, as it’s shorter to write.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_index_does_not_redirect_if_logged_in():</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app.session_transaction() <span class="im">as</span> s:</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>        s.clear()</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">&quot;logged_in&quot;</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">&quot;admin_user_id&quot;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="st">&quot;/admin/&quot;</span>)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.status_code <span class="op">==</span> <span class="dv">200</span></span></code></pre></div>
<p>This test uses the <code>session_transaction</code> method to let us modify the Flask session before our request. We use this to set the <code>"logged_in"</code> and <code>"admin_user_id"</code> values so that we are now logged in as an admin. We once again load the <code>/admin</code> route and assert that it is successful (rather than a redirect).</p>
<p>Logging in with the <code>session_transaction</code> method will be needed for a lot of our methods, so let’s create a helper at the top of this file to perform this.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> admin_login():</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app.session_transaction() <span class="im">as</span> s:</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>        s.clear()</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">&quot;logged_in&quot;</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">&quot;admin_user_id&quot;</span>] <span class="op">=</span> <span class="dv">1</span></span></code></pre></div>
<p>Before we use this, however, we should assure our login functionality works as intended:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.admin_user <span class="im">import</span> AdminUser</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((AdminUser,))</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_login_logs_user_in_with_correct_details():</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app.session_transaction() <span class="im">as</span> s:</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        s.clear()</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    create_test_admin_user(<span class="st">&quot;admin&quot;</span>, <span class="st">&quot;admin&quot;</span>)</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    form_data <span class="op">=</span> {<span class="st">&quot;username&quot;</span>: <span class="st">&quot;admin&quot;</span>, <span class="st">&quot;password&quot;</span>: <span class="st">&quot;admin&quot;</span>}</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.post(<span class="st">&quot;/admin/login&quot;</span>, data<span class="op">=</span>form_data, follow_redirects<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.status_code <span class="op">==</span> <span class="dv">200</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Welcome to the admin&quot;</span> <span class="kw">in</span> res.get_data()</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((AdminUser,))</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_login_shows_error_with_incorrect_details():</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app.session_transaction() <span class="im">as</span> s:</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>        s.clear()</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>    create_test_admin_user(<span class="st">&quot;admin&quot;</span>, <span class="st">&quot;admin&quot;</span>)</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>    form_data <span class="op">=</span> {<span class="st">&quot;username&quot;</span>: <span class="st">&quot;admin&quot;</span>, <span class="st">&quot;password&quot;</span>: <span class="st">&quot;password&quot;</span>}</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.post(<span class="st">&quot;/admin/login&quot;</span>, data<span class="op">=</span>form_data, follow_redirects<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> res.status_code <span class="op">==</span> <span class="dv">200</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Please try again!&quot;</span> <span class="kw">in</span> res.get_data()</span></code></pre></div>
<p>Before testing our login system we need to ensure there is no session, so we use <code>session_transaction</code> to ensure the session has been cleared. We then need to make an <code>AdminUser</code> which can be authenticated against. In the first test, we create our form data with the correct login details and use the <code>testing_app.post</code> method to send this to the login URL. The <code>data</code> argument is used to send our <code>form_data</code> as POST data, and the <code>follow_redirects</code> argument will make the <code>res</code> response contain the page we are redirected to, rather than a 302 status code. We then check the page we are taken to and <code>assert</code> that it contains the text from our admin header.</p>
<p>On the second test, since we send the wrong details, we check that the response contains our <code>flash</code>ed error message.</p>
<p>Before we can run these first few tests we’ll need that helper function to create an <code>AdminUser</code>. Open up <code>tests/helpers.py</code> and we’ll add helpers for our other models:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.admin_user <span class="im">import</span> AdminUser</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.order <span class="im">import</span> Order</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_test_admin_user(username: <span class="bu">str</span>, password: <span class="bu">str</span>):</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> werkzeug.security <span class="im">import</span> generate_password_hash</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> AdminUser()</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    u.username <span class="op">=</span> username</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    u.password <span class="op">=</span> generate_password_hash(password)</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>    u.save()</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> u</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_test_order(email: <span class="bu">str</span>, products: <span class="bu">dict</span>):</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    o <span class="op">=</span> Order()</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>    o.email <span class="op">=</span> email</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>    o.timestamp_created <span class="op">=</span> datetime.now().<span class="bu">format</span>(<span class="st">&quot;%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S&quot;</span>)</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    o.products <span class="op">=</span> products</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    o.save()</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> o</span></code></pre></div>
<p>Now we have the ability to make <code>AdminUser</code> and <code>Order</code> instances easily. Back to <code>tests/admin/test_admin.py</code>, let’s write tests for the CRUD functionality for <code>Product</code>s.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_create_product_shows_form():</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    admin_login()</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="ss">f&quot;/admin/create-product&quot;</span>)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    res_data <span class="op">=</span> res.get_data()</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&#39;&lt;form name=&quot;product_form&quot;&#39;</span> <span class="kw">in</span> res_data</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_edit_product_shows_populated_form():</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    admin_login()</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> create_test_product(<span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;1.50&quot;</span>)</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="ss">f&quot;/admin/</span><span class="sc">{p.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>    res_data <span class="op">=</span> res.get_data()</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Floss&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;1.50&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&#39;&lt;form name=&quot;product_form&quot;&#39;</span> <span class="kw">in</span> res_data</span></code></pre></div>
<p>To check creating we use our <code>admin_login</code> helper to set up our session, then load the <code>/create-product</code> URL and check that our form is there.</p>
<p>For editing we first need a product, so we create one using the helper. We then visit the admin URL for that product and check the name and price are shown, as well as the form.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_save_product_as_create():</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    admin_login()</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Product.select().count() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    form_data <span class="op">=</span> {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;price&quot;</span>: <span class="st">&quot;1.50&quot;</span>}</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    testing_app.post(<span class="st">&quot;/admin/save-product&quot;</span>, data<span class="op">=</span>form_data)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Product.select().count() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> Product.get()</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> p.name <span class="op">==</span> <span class="st">&quot;Floss&quot;</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> p.price <span class="op">==</span> <span class="st">&quot;1.50&quot;</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_save_product_as_edit():</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    admin_login()</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.99&quot;</span>)</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Product.select().count() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>    form_data <span class="op">=</span> {<span class="st">&quot;product_id&quot;</span>: p.<span class="bu">id</span>, <span class="st">&quot;name&quot;</span>: <span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;price&quot;</span>: <span class="st">&quot;1.50&quot;</span>}</span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>    testing_app.post(<span class="st">&quot;/admin/save-product&quot;</span>, data<span class="op">=</span>form_data)</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Product.select().count() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> Product.get()</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> p.name <span class="op">==</span> <span class="st">&quot;Floss&quot;</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> p.price <span class="op">==</span> <span class="st">&quot;1.50&quot;</span></span></code></pre></div>
<p>We test saving in the context of both a create and an edit. For create we first check there are no instances in our database, using Peewee’s <code>select().count()</code>, then POST some form data to our <code>/save-product</code> URL. We now check that the database has an entry, and that the data in that entry is the same as from our form data.</p>
<p>Updating requires an existing product, so we create one and assert that it’s the only record in our database. Then we post form data with different values and check that a new instance was <em>not</em> created. We finish by asserting that the form data has replaced the original data for this record.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_delete_product():</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    admin_login()</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> create_test_product(<span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;1.50&quot;</span>)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Product.select().count() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    form_data <span class="op">=</span> {<span class="st">&quot;product_id&quot;</span>: p.<span class="bu">id</span>}</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    testing_app.post(<span class="st">&quot;/admin/delete-product&quot;</span>, data<span class="op">=</span>form_data)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Product.select().count() <span class="op">==</span> <span class="dv">0</span></span></code></pre></div>
<p>Finally, deleting a product is tested by creating an instance then POSTing its ID to our <code>/delete-product</code> URL. We then check that the row has been removed from our database.</p>
<p>Great, that’s all of our admin section tested! We can now be sure that adding new functionality won’t change the expected behaviour of any of these URLs.</p>
<h3 id="testing-the-shop">Testing the Shop</h3>
<p>Since we last wrote tests for the shop we’ve added a Cart and Checkout functionality. Let’s get tests for these features going. Open up <code>tests/site/test_site.py</code>:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Product,))</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_add_product_to_cart():</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> create_test_product(<span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;1.50&quot;</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    p2 <span class="op">=</span> create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.99&quot;</span>)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app <span class="im">as</span> app_with_session:</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>        app_with_session.get(<span class="st">&quot;/&quot;</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> flask <span class="im">import</span> session</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="st">&quot;cart&quot;</span> <span class="kw">in</span> session</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> session[<span class="st">&quot;cart&quot;</span>] <span class="op">==</span> []</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> app_with_session.post(<span class="st">&quot;/add-product-to-cart&quot;</span>, data<span class="op">=</span>{<span class="st">&quot;product_id&quot;</span>: p.<span class="bu">id</span>})</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> session[<span class="st">&quot;cart&quot;</span>] <span class="op">==</span> [p.<span class="bu">id</span>]</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> res.get_json()[<span class="st">&quot;cart_items&quot;</span>] <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> app_with_session.post(<span class="st">&quot;/add-product-to-cart&quot;</span>, data<span class="op">=</span>{<span class="st">&quot;product_id&quot;</span>: p2.<span class="bu">id</span>})</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> session[<span class="st">&quot;cart&quot;</span>] <span class="op">==</span> [p.<span class="bu">id</span>, p2.<span class="bu">id</span>]</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> res.get_json()[<span class="st">&quot;cart_items&quot;</span>] <span class="op">==</span> <span class="dv">2</span></span></code></pre></div>
<p>In order to test our Cart we need some products to add to it, so we create two using our helper.</p>
<p>The Flask session is not usually available to be imported in tests, but we can use a <code>with</code> block around our <code>testing_app</code> which will allow us to import and check the contents of the <code>session</code> whilst inside.</p>
<p>Using this, we fire a request to the index page in order to create an empty <code>cart</code> in our <code>session</code>. We can then import this <code>session</code> and check for its presence.</p>
<p>A couple of requests to <code>/add-product-to-cart</code> are fired off and the <code>session</code>’s <code>cart</code> is checked for their IDs.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Order, Product))</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_checkout_get():</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> create_test_product(<span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;1.50&quot;</span>)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    p2 <span class="op">=</span> create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.99&quot;</span>)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app.session_transaction() <span class="im">as</span> s:</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>        s.clear()</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">&quot;cart&quot;</span>] <span class="op">=</span> [p.<span class="bu">id</span>, p.<span class="bu">id</span>, p2.<span class="bu">id</span>]</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.get(<span class="st">&quot;/checkout&quot;</span>)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    res_data <span class="op">=</span> res.get_data()</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Floss&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Toothbrush&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;3.00&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;2.99&quot;</span> <span class="kw">in</span> res_data</span></code></pre></div>
<p>To test our Checkout page we create two products and use a <code>session_transaction</code> to put them into our Cart. We then load the <code>/checkout</code> page and get its contents. The names and prices of our products are checked for inside (we look for <code>"3.00"</code> since we have 2 instances of our Floss at 1.50).</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Order, Product))</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_checkout_post():</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> create_test_product(<span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;1.50&quot;</span>)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    p2 <span class="op">=</span> create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.99&quot;</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Order.select().count() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app.session_transaction() <span class="im">as</span> s:</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>        s.clear()</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">&quot;cart&quot;</span>] <span class="op">=</span> [p.<span class="bu">id</span>, p.<span class="bu">id</span>, p2.<span class="bu">id</span>]</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.post(</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/checkout&quot;</span>, data<span class="op">=</span>{<span class="st">&quot;email&quot;</span>: <span class="st">&quot;a@a.com&quot;</span>}, follow_redirects<span class="op">=</span><span class="va">True</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    res_data <span class="op">=</span> res.get_data()</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Floss&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Toothbrush&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;3.00&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;2.99&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;sent to a@a.com&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Order.select().count() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>    o <span class="op">=</span> Order.get()</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> o.email <span class="op">==</span> <span class="st">&quot;a@a.com&quot;</span></span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> o.products <span class="op">==</span> {</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Floss&quot;</span>: {<span class="st">&quot;total&quot;</span>: <span class="fl">3.0</span>, <span class="st">&quot;quantity&quot;</span>: <span class="dv">2</span>},</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Toothbrush&quot;</span>: {<span class="st">&quot;total&quot;</span>: <span class="fl">2.99</span>, <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>},</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div>
<p>Placing an order is done by a POST request to <code>/checkout</code> with products in our Cart and an email address sent via the form. We begin by creating our products again and adding them to our Cart. We also check the <code>Order</code> table to ensure it’s empty.</p>
<p>After our POST request containing our email address, we check again for the same product information, as well as the email confirmation message.</p>
<p>We finish by ensuring the <code>Order</code> has been created, and check it holds the correct data.</p>
<p>With that, our site is fully tested! We have the ability to quickly and easily check that the core behaviours of our site and admin remain intact as we add or remove features.</p>
<p>To finish off our project, we will have a brief look at how we can run code which makes use of our site’s data but outside of the context of a web request, using a library called Celery.</p>
<h1 id="chapter-7">Chapter 7</h1>
<h2 id="background-tasks-with-celery">Background Tasks with Celery</h2>
<p>Sometimes we may have tasks which do not necessarily need to run <em>before</em> we provide feedback to the user. For example, a lot of online shops will not make customers sit and wait while their system sends the confirmation email. This allows developers to do potentially-slow data processing tasks without leaving the user staring at a “loading…” message. One way we achieve this with a Flask website is to make use of a python library named Celery.</p>
<p>Celery allows us to take advantage of separate “workers” running tasks independently of the web application but still using its data. These workers run in separate processes, meaning heavy processing tasks will not affect any web requests.</p>
<h3 id="heavy-processing">Heavy Processing</h3>
<p>Let’s emulate a heavy processing task by adding a confirmation email to our Checkout endpoint. Create a folder in the root of your project called <code>tasks</code> and inside make a python file called <code>send_email.py</code>:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> send_confirmation_email(email: <span class="bu">str</span>):</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">5</span>)  <span class="co"># emulate processing</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;sending email to </span><span class="sc">{</span>email<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<p>This function sleeps for 5 seconds to emulate a complex database query, then prints a message about emailing the provided <code>email</code>. Sending an email is complex, and therefore out of scope for the purposes of this book, so we’ll make do with this <code>print</code> statement.</p>
<p>Now open up <code>web/views/site/site.py</code> and add a call to this function in your <code>complete</code> view:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tasks.send_email <span class="im">import</span> send_confirmation_email</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> complete():</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    send_confirmation_email(order.email)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">&quot;complete.html&quot;</span>, order<span class="op">=</span>order)</span></code></pre></div>
<p>Open up your shop’s website and add some items to your Cart, then Checkout. You will notice your site hangs for a while before showing you the confirmation page. This is likely to be frustrating to users, who may leave the site, or refresh the page thinking something is wrong and accidentally place two orders.</p>
<p>Let’s now add Celery to our project so that we can remedy this potential issue.</p>
<h3 id="adding-celery">Adding Celery</h3>
<p>In order to run background tasks Celery itself needs a way to manage a queue. For this example we will be using Redis since it is very easy to set up and use.</p>
<p>In a new terminal window, source your virtualenv with <code>source env/bin/activate</code> then run <code>poetry add celery celery[redis]</code> to install Celery and its dependencies.</p>
<p>While this is installing we can bring in Redis. Specific instructions for doing this depend on the Operating System you are using, so search the web for “Redis install <code>my_operating_system</code>” and find the official docs. On Linux, Redis is most likely available in your distro’s repositories. MacOS can use <code>homebrew</code>, and Windows users can use the WSL terminal they are using to follow along with this book.</p>
<p>With Redis installed, running the server is as easy as executing the command <code>redis-server</code>. You can leave this running while we set up Celery in our code.</p>
<p>Stop your web server if you haven’t already and open up <code>web_server.py</code> in your editor. Change the beginning of the file to look like so:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery <span class="im">import</span> Celery</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>app.secret_key <span class="op">=</span> <span class="st">&quot;very secret&quot;</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>celery <span class="op">=</span> Celery(<span class="st">&quot;My Shop&quot;</span>, broker<span class="op">=</span><span class="st">&quot;redis://localhost:6379/0&quot;</span>)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web.views <span class="im">import</span> admin, site</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p>Now open your <code>tasks/send_email.py</code> file and we can turn the <code>send_confirmation_email</code> function into a Celery task:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web_server <span class="im">import</span> celery</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="at">@celery.task</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> send_confirmation_email(email: <span class="bu">str</span>):</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">5</span>)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;sending email to </span><span class="sc">{</span>email<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<p>Turning a synchronous function into an async one is as easy as importing <code>celery</code> and decorating the function with <code>@celery.task</code>. Now our Celery worker can see this task and will be able to process it independently of our web server.</p>
<p>To run a Celery worker we’ll need an entry point to our application. Create a file called <code>run.py</code> in the root of the project:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> web_server <span class="im">import</span> celery</span></code></pre></div>
<p>And now we are set up to run a Celery worker! Open up a new terminal and source your virtualenv. Now run the following command:</p>
<pre><code>celery -A run worker -l info -E</code></pre>
<p>This points Celery to our new <code>run.py</code> file, tells it to run a <code>worker</code>, sets the <code>loglevel</code> to <code>info</code> so that we can see what it’s doing, and finally uses <code>-E</code> to tell the worker to log events about each job.</p>
<p>One last thing now - we need to tell our <code>complete</code> view to call this function asynchronously using the Celery worker. We do this by calling the <code>delay</code> function which has now been added by the <code>@celery.task</code> decorator. Open up <code>web/views/site/site.py</code> and change the line in <code>complete</code>:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>    send_confirmation_email.delay(order.email)</span></code></pre></div>
<p>Now our slow function will be executed by the Celery worker, meaning the customer will see the Complete page without waiting for their confirmation email to be sent.</p>
<p>Start up your web server with <code>python3 web_server.py</code> and buy some products on your website. You should notice the Complete page does not hang any more. Open the terminal running your <code>celery</code> command and you should see a message similar to this:</p>
<pre><code>[2022-05-02 07:31:27,561: WARNING/ForkPoolWorker-8] sending email to test@example.com</code></pre>
<p>Congratulations, you have successfully run a background task from your website!</p>
<h3 id="adjusting-the-tests">Adjusting the Tests</h3>
<p>Since we should not have to run Redis in order to test our application, we’ll need to stop our server from trying to connect during tests. We can detect if we are testing using this line:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">&quot;pytest&quot;</span> <span class="kw">in</span> sys.modules:</span></code></pre></div>
<p>Open up <code>factory.py</code> and change the creation of the <code>celery</code> instance to the following:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">&quot;pytest&quot;</span> <span class="kw">in</span> sys.modules:</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    celery <span class="op">=</span> Celery(<span class="st">&quot;My Shop&quot;</span>, broker<span class="op">=</span><span class="st">&quot;memory://&quot;</span>)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    celery <span class="op">=</span> Celery(<span class="st">&quot;My Shop&quot;</span>, broker<span class="op">=</span><span class="st">&quot;redis://localhost:6379/0&quot;</span>)</span></code></pre></div>
<p>This will tell Celery to use an in-memory queue during unit tests. This does not work when actually trying to use Celery in practise, which is why we had to install Redis.</p>
<p>With Celery taken care of, our tests should now run successfully. However, we can actually now check that the confirmation email task is called when an order completes.</p>
<h4 id="mocking-celerys-delay">Mocking Celery’s Delay</h4>
<p>In a new terminal window, source your virtualenv and run <code>poetry add --dev pytest-mock</code>. This will allow us to use Mocking to test if a function has been called during the execution of another.</p>
<p>First, we’ll create a mock of the <code>delay</code> function in our <code>tests/helpers.py</code> file:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>__all__ <span class="op">=</span> [</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mock_send_confirmation_email_delay&quot;</span>,</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;with_test_db&quot;</span>,</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mock_send_confirmation_email_delay(mocker):</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tasks.send_email <span class="im">import</span> send_confirmation_email</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    mocker.patch.<span class="bu">object</span>(send_confirmation_email, <span class="st">&quot;delay&quot;</span>, autospec<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<p>We use the <code>mocker</code> fixture (which will be passed to this function) to <code>patch</code> the <code>delay</code> function with a mock. This will then allow us to inspect whether the function was called during the test.</p>
<p>Now open up <code>tests/site/test_site.py</code> and change your <code>test_checkout_post</code> function to the following:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="at">@with_test_db</span>((Order, Product))</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_checkout_post(mocker):</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    mock_send_confirmation_email_delay(mocker)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> create_test_product(<span class="st">&quot;Floss&quot;</span>, <span class="st">&quot;1.50&quot;</span>)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    p2 <span class="op">=</span> create_test_product(<span class="st">&quot;Toothbrush&quot;</span>, <span class="st">&quot;2.99&quot;</span>)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Order.select().count() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> testing_app.session_transaction() <span class="im">as</span> s:</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>        s.clear()</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>        s[<span class="st">&quot;cart&quot;</span>] <span class="op">=</span> [p.<span class="bu">id</span>, p.<span class="bu">id</span>, p2.<span class="bu">id</span>]</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> testing_app.post(</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;/checkout&quot;</span>, data<span class="op">=</span>{<span class="st">&quot;email&quot;</span>: <span class="st">&quot;a@a.com&quot;</span>}, follow_redirects<span class="op">=</span><span class="va">True</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    res_data <span class="op">=</span> res.get_data()</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Floss&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;Toothbrush&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;3.00&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;2.99&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> b<span class="st">&quot;sent to a@a.com&quot;</span> <span class="kw">in</span> res_data</span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> Order.select().count() <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>    o <span class="op">=</span> Order.get()</span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> o.email <span class="op">==</span> <span class="st">&quot;a@a.com&quot;</span></span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> o.products <span class="op">==</span> {</span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Floss&quot;</span>: {<span class="st">&quot;total&quot;</span>: <span class="fl">3.0</span>, <span class="st">&quot;quantity&quot;</span>: <span class="dv">2</span>},</span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Toothbrush&quot;</span>: {<span class="st">&quot;total&quot;</span>: <span class="fl">2.99</span>, <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>},</span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tasks.send_email <span class="im">import</span> send_confirmation_email</span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>    send_confirmation_email.delay.assert_called_once()</span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> send_confirmation_email.delay.call_args[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">==</span> <span class="st">&quot;a@a.com&quot;</span></span></code></pre></div>
<p>The test now takes an argument called <code>mocker</code>, which will be injected by the <code>pytest-mock</code> library we installed. This is passed to the <code>mock_send_confirmation_email_delay</code> helper function to carry out the mocking.</p>
<p>Once we have asserted that the contents of the page are as expected, we have two new asserts at the end of our test. We first use <code>assert_called_once</code> to check that our <code>send_confirmation_email</code> function was sent to the Celery worker. Then we can use its <code>call_args</code> attribute to check that the argument passed to this function was the email address we entered. The <code>[0][0]</code> is used to get the first call to this function, then the first argument of that call. Since there is only one call, and only one argument, this is all we need to check.</p>
<p>Fantastic, we’ve now got a way of running background tasks outside of a web request to avoid slowing down the user’s page load, and we have an automated test to ensure they are called with the correct arguments!</p>
<p>With that, our project is now complete! We have ourselves a website split into two sections - an admin protected by a login, and a public-facing shop. We can process and store customer orders in a database, and process the data within outside of a web request context using Celery. Our whole application has a suite of automated tests which ensure that the critical functionality is behaving as it should.</p>
<h1 id="appendix-1---peewee">Appendix 1 - Peewee</h1>
<p><a href="#chapter-2">(Back to Chapter 2)</a></p>
<p>In these appendices I will be covering some more complex parts of the mentioned libraries which I couldn’t fit into our simple example, but still deem important to know. These can be read either before following the book’s examples, or after finishing the project.</p>
<p>As always, the official Peewee docs are going to be more accurate than what is written here.</p>
<p>These examples are correct for Peewee version <strong>3.14.8</strong>.</p>
<h2 id="basics">Basics</h2>
<h3 id="selecting">Selecting</h3>
<p>Call the <code>.select</code> method on your model class:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>Book.select()</span></code></pre></div>
<p>This is the equivalent of <code>SELECT * FROM book;</code>.</p>
<p>This function returns an <code>iterable</code> of instances of your Model class (<code>Book</code> in this example). To make use of them, you will then need to consume the iterable with either a <code>for</code> loop or list comprehension:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>books <span class="op">=</span> Book.select()</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> book <span class="kw">in</span> books:</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `book` is now an instance of the `Book` model class. </span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(book.title)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="co"># OR:</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>books <span class="op">=</span> Book.select()</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>all_books <span class="op">=</span> [b <span class="cf">for</span> b <span class="kw">in</span> books]</span></code></pre></div>
<h4 id="selecting-specific-fields">Selecting specific fields</h4>
<p>All examples in this book’s project select all fields from our tables, as they are small. This can be a performance hit as tables grow larger.</p>
<p>To select only specific columns, pass the model name, a dot, and the attribute as arguments to your <code>.select</code> call. For example:</p>
<pre><code>Book.select(Book.author, Book.title)</code></pre>
<p>This query selects only the author and title columns.</p>
<h3 id="conditions">Conditions</h3>
<p>To filter what you are selecting, pass regular python conditional statements to a <code>.where</code> call:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>Book.select().where(Book.title <span class="op">==</span> <span class="st">&quot;Flask by Example&quot;</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>Book.select().where(Book.price <span class="op">&gt;=</span> <span class="fl">5.00</span>)</span></code></pre></div>
<p>To pass multiple conditions, wrap each in brackets and separate them with an ampersand <code>&amp;</code> for <code>AND</code>, or a pipe <code>|</code> for OR.</p>
<p>For example:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>Book.select().where( (Book.price <span class="op">&gt;=</span> <span class="fl">5.00</span>) <span class="op">&amp;</span> (Book.published <span class="op">==</span> <span class="va">True</span>) )</span></code></pre></div>
<p>Is the equivalent of:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> book <span class="kw">WHERE</span> book.price <span class="op">&gt;=</span> <span class="fl">5.00</span> <span class="kw">AND</span> book.published <span class="op">=</span> <span class="kw">true</span>;</span></code></pre></div>
<p>For an <code>OR</code> query:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>Book.select().where( (Book.title <span class="op">==</span> <span class="st">&quot;Flask By Example&quot;</span>) <span class="op">|</span> (Book.title <span class="op">==</span> <span class="st">&quot;Tkinter By Exmaple&quot;</span>) )</span></code></pre></div>
<p>Is the equivalent of:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> book <span class="kw">WHERE</span> book.title <span class="op">=</span> <span class="st">&#39;Flask By Example&#39;</span> <span class="kw">OR</span> book.title <span class="op">=</span> <span class="st">&#39;Tkinter By Example&#39;</span>;</span></code></pre></div>
<p>You can combine both <code>AND</code> and <code>OR</code> using brackets, just like in regular SQL:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>Book.select().where(</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>        (Book.date_published <span class="op">&gt;</span> <span class="st">&quot;2020-01-01&quot;</span>)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">|</span> (</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>        (Book.date_published <span class="op">&lt;</span> <span class="st">&quot;2020-01-01&quot;</span>) <span class="op">&amp;</span> (Book.revenue <span class="op">&gt;=</span> <span class="dv">100</span>) </span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The above selects all books which are either newer than Jan 1st 2020, or both older than Jan 1st 2020 and have a revenue above 100. In SQL this would be:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> book <span class="kw">WHERE</span> (book.date_published <span class="op">&gt;</span> <span class="st">&#39;2020-01-01&#39;</span>) <span class="kw">OR</span> (book.date_published <span class="op">&lt;</span> <span class="st">&#39;2020-01-01&#39;</span> <span class="kw">AND</span> book.revenue <span class="op">&gt;=</span> <span class="dv">100</span>);</span></code></pre></div>
<h3 id="getting-a-single-instance">Getting a Single Instance</h3>
<p>If there should only be a single instance of a row matching your condition, you can use the <code>.get</code> method to grab it directly. Arguments passed to this method are the same conditionals as would be passed to a <code>.where</code> call.</p>
<p>For example:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>flask_book <span class="op">=</span> Book.get(Book.name <span class="op">==</span> <span class="st">&quot;Flask By Example&quot;</span>)</span></code></pre></div>
<p>Here your <code>flask_book</code> variable will be an instance of your <code>Book</code> model.</p>
<p>This will throw a <code>ModelNotFound</code> exception if the criteria do not match and no record could be found.</p>
<p>If you aren’t certain that there is a matching row in your database, you can instead use <code>.get_or_none</code>, which will return a <code>Model</code> instance if a match is found, or <code>None</code> if not.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>maybe_book <span class="op">=</span> Book.get_or_none(Book.title <span class="op">==</span> <span class="st">&quot;Flask By Example&quot;</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> maybe_book:</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;No book with that name&quot;</span>)</span></code></pre></div>
<h2 id="advanced">Advanced</h2>
<h3 id="aliases">Aliases</h3>
<p>You can append <code>.alias</code> to an attribute inside a call to <code>.select</code> to alias the field. This is useful in situations where multiple tables have a column with the same name. For example:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>Book.select(Book.author, Book.title.alias(<span class="st">&quot;book_title&quot;</span>))</span></code></pre></div>
<p>This selects a Book’s author, and aliases its title to <code>book_title</code>.</p>
<h3 id="joins">Joins</h3>
<p>Join two tables by appending a call to <code>.join</code> after a <code>.select</code>. The call to join takes two arguments - the Model class to join with, and a condition on which to perform the join, named <code>on</code>. To select fields from a joined table, simply pass the Model’s name and attribute to <code>select</code> as normal.</p>
<p>For example:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>Book.select(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    Book.title, Book.author, Author.date_of_birth</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>).join(</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    Author, on<span class="op">=</span>(Author.name <span class="op">==</span> Book.author)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>This example performs the query:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> book.title, book.author, author.date_of_birth</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> book</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> author <span class="kw">ON</span> author.name <span class="op">=</span> book.author;</span></code></pre></div>
<h4 id="join-types">Join types</h4>
<p>Join types are available as constants which can be imported from Peewee like so:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peewee <span class="im">import</span> JOIN</span></code></pre></div>
<p>These are then passed as the second argument to your <code>.join</code> call:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peewee <span class="im">import</span> JOIN</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>Book.select(</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    Book.title, Book.author, Author.date_of_birth</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>).join(</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    Author, JOIN.INNER, on<span class="op">=</span>(Author.name <span class="op">==</span> Book.author)</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>See the Peewee documentation for an up-to-date list of available joins.</p>
<h3 id="functions">Functions</h3>
<p>Functions are found in a module named <code>fn</code>. If you know the name of the function you would like to use in regular SQL, it is probably called the same thing in the Peewee module.</p>
<p>For example, to use a <code>MAX</code> function:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peewee <span class="im">import</span> fn</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>most_copies_sold <span class="op">=</span> Book.select(fn.MAX(Book.copies_sold))</span></code></pre></div>
<p>You can also alias these function calls:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peewee <span class="im">import</span> fn</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>books <span class="op">=</span> Book.select(fn.SUM(Book.revenue).alias(<span class="st">&quot;total_revenue&quot;</span>), Book.title).group_by(Book.title)</span></code></pre></div>
<h3 id="group-by-order-by-limit-offset">Group By, Order By, Limit, Offset</h3>
<p>These functionalities are all offered by functions of the same name. For example:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>books <span class="op">=</span> Book.select(Book.title, fn.SUM(Book.revenue)).group_by(Book.title).order_by(Book.title.asc()).limit(<span class="dv">5</span>).offset(<span class="dv">5</span>)</span></code></pre></div>
<p>As above, ordering is done by specifying the Model class and attibute, then appending <code>.asc()</code> or <code>.desc()</code> for ascending or descending. To alter where NULLs appear, pass <code>nulls="LAST"</code> or <code>nulls="FIRST"</code> to <code>.asc</code> or <code>.desc</code>.</p>
<h1 id="appendix-2---pytest">Appendix 2 - Pytest</h1>
<p><a href="#chapter-3">(Back to Chapter 3)</a></p>
<p>In these appendices I will be covering some more complex parts of the mentioned libraries which I couldn’t fit into our simple example, but still deem important to know. These can be read either before following the book’s examples, or after finishing the project.</p>
<p>As always, the official Pytest docs are going to be more accurate than what is written here.</p>
<p>These examples are correct for Pytest version <strong>7.0.0</strong>.</p>
<h2 id="basics-1">Basics</h2>
<p>Tests by default live in a folder called <code>tests</code>. Within that folder, any python files which begin with <code>test_</code> will be run by Pytest. Similarly, any functions inside those files which begin with <code>test_</code> will be detected and executed as tests.</p>
<p>Running tests is achieved by executing the command <code>pytest</code> in the same directory as your <code>tests</code> folder. If you specify a file as the second argument, e.g. <code>pytest tests/models/test_models.py</code>, only that file will be run.</p>
<p>Some of the flags you may want to pass to the command are:</p>
<ul>
<li><code>-s</code> Show the ouput of <code>print</code> statements.</li>
<li><code>-x</code> Stop after a test fails.</li>
<li><code>-v</code> Display the file and function of each test as it runs.</li>
<li><code>-k</code> Only run tests whose name matches a provided string. For example <code>pytest -k email</code> will only run tests if their function name contains the word “email”.</li>
</ul>
<p>You can pass multiple flags in one go, for example <code>pytest -sxv</code>.</p>
<h2 id="advanced-1">Advanced</h2>
<h3 id="fixtures">Fixtures</h3>
<p>Fixtures are a rather deep topic, which you can find on the Pytest docs in more detail than I could ever write. However, for the purpose of understanding this book, you can think of a fixture as <em>an object injected into a test which requires it</em>.</p>
<p>The two fixtures I find myself using the most are <code>mocker</code> for Mocking and <code>monkeypatch</code> for Patching.</p>
<h3 id="mocking">Mocking</h3>
<p>Mocking is replacing a piece of code with a dummy object which keeps track of how many times it was called and with what arguments. This dummy function will <em>not</em> execute the original code.</p>
<p>Mocking in Pytest is made very easy with the <code>pytest-mock</code> library. With this installed simply add a parameter named <code>mocker</code> to your test functions and a <code>Mock</code> object will be injected.</p>
<h4 id="mocking-a-function">Mocking a Function</h4>
<p>To mock a function, pass a string representing the import path to the function to <code>mocker.patch</code>, like so:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>mocker.patch(<span class="st">&quot;helpers.emails.send_email&quot;</span>)</span></code></pre></div>
<p>Now in your test, import this function and use a method to check it was / wasn’t called:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_send_email_called(mocker):</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    mocker.patch(<span class="st">&quot;helpers.emails.send_email&quot;</span>)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    function_which_should_send_email()</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> helpers.emails <span class="im">import</span> send_email</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    send_email.assert_called_once()</span></code></pre></div>
<h4 id="mocking-an-object">Mocking an Object</h4>
<p>To mock a method of an object, rather than a standalone function, use <code>mocker.patch.object</code>. Pass the object as the first argument, and a string of the method to mock as the second.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>mocker.patch.<span class="bu">object</span>(Book, <span class="st">&quot;get_total_revenue&quot;</span>)</span></code></pre></div>
<p>You can now check the method was called in much the same way as a function:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_get_total_revenue(mocker):</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> models.book <span class="im">import</span> Book</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    mocker.patch.<span class="bu">object</span>(Book, <span class="st">&quot;get_total_revenue&quot;</span>)</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    get_all_book_revenues()</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    Book.get_total_revenue.assert_called_once()</span></code></pre></div>
<h3 id="spying">Spying</h3>
<p>Spying is like Mocking, except the original functionality of the mocked function <em>will</em> execute. This is useful during integration tests, where subsequent function calls rely on the results of the one you wish to mock.</p>
<p>Spying is also handled by the <code>pytest-mock</code> module, and is available in the <code>mocker</code> fixture.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_get_total_revenue(mocker):</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> models.book <span class="im">import</span> Book</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    book_spy <span class="op">=</span> mocker.spy(Book, <span class="st">&quot;get_total_revenue&quot;</span>)</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    get_all_book_revenues()</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    book_spy.assert_called_once()</span></code></pre></div>
<h3 id="patching">Patching</h3>
<p>Patching is changing the behaviour of a function or method temporarily for the duration of a single test. This is useful for integration tests which rely on functions gathering data which is not static, such as the current date or a request to an external API.</p>
<p>Patching is achieved using the <code>monkeypatch</code> fixture built in to Pytest.</p>
<h4 id="patching-a-function">Patching a function</h4>
<p>Patching a function is a bit more complicated than mocking, but the syntax is generally similar. The <code>monkeypatch</code> object uses the <code>setattr</code> method to patch a function, which requires the function-to-patch as the first argument, and the replacement function as the second.</p>
<p>Instead of passing the function directly, however, you need to pass its <code>__code__</code> attribute:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> patched_send_email():</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;sending&quot;</span>)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>monkeypatch.<span class="bu">setattr</span>(<span class="st">&quot;helpers.emails.send_email.__code__&quot;</span>, patched_send_email.__code__)</span></code></pre></div>
<h4 id="patching-an-object">Patching an Object</h4>
<p>Patching an object does not require the use of <code>__code__</code>, and is also achieved via <code>setattr</code>. The first argument is the object, the second is a string of the method to patch, and the third is the replacement function:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> models.book <span class="im">import</span> Book</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> patched_get_total_rev():</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">50.00</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>monkeypatch.<span class="bu">setattr</span>(Book, <span class="st">&quot;get_total_revenue&quot;</span>, patched_get_total_rev)</span></code></pre></div>
</body>
</html>
